<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª</title>

  <style>
    :root { --z-canvas:1; --z-video:3; --z-menu:4; --z-ui:5; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}

    /* AR canvas (–∫–∞–º–µ—Ä—ã–Ω —Ñ–∏–π–¥) –∞—Ä–¥ —Ç–∞–ª–¥ */
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;z-index:var(--z-canvas);background:#000}

    /* –î—ç—ç—Ä –¥–∞–≤—Ö–∞—Ä–ª–∞—Ö –≤–∏–¥–µ–æ/–º–µ–Ω—é */
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);touch-action:none}
    .overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;object-position:center;background:transparent;display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu)}
    .menu-inner{display:flex;flex-direction:column;gap:12px}
    .btn{width:220px;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}

    #startLayer{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:var(--z-ui);background:#000}
    #btnStart{font-size:18px}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);
           padding:6px 8px;border-radius:6px;font:12px/1.2 monospace;white-space:pre-wrap;max-width:90vw}
  </style>

  <!-- CDN (smoke-test-—Ç—ç–π –∏–∂–∏–ª) -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    // —Ö—É—É—á–∏–Ω service worker-—É—É–¥—ã–≥ —Å–∞–ª–≥–∞—Ö
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    // THREE + ZapparThree –±—ç–ª—ç–Ω –±–æ–ª–º–æ–≥—Ü
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: booting‚Ä¶</div>

  <!-- ‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–• (–∏–Ω—Ç—Ä–æ-–≥ –¥—É—É–≥–∞–∞—Ä —ç—Ö–ª“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ gesture —Ö—ç—Ä—ç–≥—Ç—ç–π) -->
  <div id="startLayer"><button id="btnStart" class="btn">‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–•</button></div>
  <button id="btnUnmute" class="btn">üîä –î—É—É–≥ –∞—Å–∞–∞—Ö</button>

  <!-- –î—ç—ç—Ä –¥–∞–≤—Ö–∞—Ä–ª–∞—Ö –≤–∏–¥–µ–æ –¥–∞–≤—Ö–∞—Ä–≥–∞ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <script>
    /********** Intro + UI **********/
    const INTRO_URL        = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const EXERCISE_URL     = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const MP4_EXERCISE_URL = ""; // iOS fallback MP4 —Ö—ç—Ä—ç–≥—Ç—ç–π –±–æ–ª —ç–Ω–¥

    const dbg = (m)=>document.getElementById('debug').textContent = 'DEBUG: ' + m;

    const intro   = document.getElementById('intro');
    const exercise= document.getElementById('exercise');
    const menu    = document.getElementById('menu');
    const startLy = document.getElementById('startLayer');
    const btnStart= document.getElementById('btnStart');
    const btnUnmute=document.getElementById('btnUnmute');
    const wrap    = document.getElementById('overlay-wrap');

    let audioCtx;
    async function ensureAudio(){
      try{
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if(!Ctx) return;
        audioCtx ||= new Ctx();
        if(audioCtx.state === 'suspended') await audioCtx.resume();
      }catch{}
    }
    function setSources(el, webm, mp4=""){
      el.innerHTML = "";
      el.crossOrigin = "anonymous";
      el.preload = "auto";
      if (webm){ const s1=document.createElement('source'); s1.src=webm; s1.type='video/webm; codecs="vp8,opus"'; el.appendChild(s1); }
      if (mp4 ){ const s2=document.createElement('source'); s2.src=mp4 ; s2.type='video/mp4'; el.appendChild(s2); }
      el.load();
    }

    // ‚ñ∂ –∏–Ω—Ç—Ä–æ-–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö (–¥—É—É–Ω—ã policy-–Ω —É–ª–º–∞–∞—Å —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –¥–∞—Ä–∞–ª—Ç —Ö—ç—Ä—ç–≥—Ç—ç–π)
    btnStart.addEventListener('click', async () => {
      await ensureAudio();
      setSources(intro, INTRO_URL);
      setSources(exercise, EXERCISE_URL, MP4_EXERCISE_URL);
      intro.currentTime = 0;
      intro.style.display = "block";
      intro.muted = false;
      try{
        await intro.play();
        startLy.style.display='none';
        btnUnmute.style.display='none';
        dbg('intro playing (with sound)');
      }catch{
        intro.muted = true;
        await intro.play().catch(()=>{});
        startLy.style.display='none';
        btnUnmute.style.display='inline-block';
        dbg('intro autoplay blocked ‚Üí show Unmute');
      }
    });
    btnUnmute.addEventListener('click', async ()=>{
      await ensureAudio();
      intro.muted = false;
      await intro.play().catch(()=>{});
      btnUnmute.style.display='none';
      dbg('intro unmuted');
    });
    intro.addEventListener('ended', ()=>{
      intro.style.display = "none";
      menu.style.display = "flex";
      dbg('intro ended ‚Üí menu');
    });
  </script>

  <!-- ********** WebAR / Zappar (permission-–∏–π–≥ –®–£–£–î on load) ********** -->
  <script>
    let renderer, camera, scene, instantTracker, anchorGroup;
    (async function initAR(){
      const { THREE, ZapparThree } = await window.__depsReady;
      if (!THREE || !ZapparThree) { alert('THREE/ZapparThree –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π'); throw new Error('Deps'); }

      // Renderer (canvas-–≥ –∞—Ä —Ç–∞–ª–¥ –±–∞–π—Ä–ª—É—É–ª–Ω–∞)
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
      renderer.setSize(innerWidth, innerHeight);
      renderer.domElement.classList.add('webgl');
      document.body.appendChild(renderer.domElement);
      addEventListener('resize', ()=>renderer.setSize(innerWidth, innerHeight));
      ZapparThree.glContextSet(renderer.getContext());

      if (ZapparThree.browserIncompatible()) { ZapparThree.browserIncompatibleUI(); return; }

      // –ö–∞–º–µ—Ä + Scene
      camera = new ZapparThree.Camera({ userFacing:false });
      scene  = new THREE.Scene();
      scene.background = camera.backgroundTexture;

      // ‚òÖ –û—Ä–æ—Ö–¥–æ–æ —à—É—É–¥ permission –∞—Å—É—É–Ω–∞
      const ok = await ZapparThree.permissionRequest();
      if (!ok) { ZapparThree.permissionDeniedUI(); return; }
      camera.start();
      dbg('zappar camera started');

      // Render loop “Ø—Ä–≥—ç–ª–∂ –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–≥
      renderer.setAnimationLoop(()=>{
        camera.updateFrame(renderer);
        renderer.render(scene, camera);
      });
    })();

    // ‚Äû–î–∞—Å–≥–∞–ª‚Äú –¥—ç—ç—Ä AR –∫–æ–Ω—Ç–µ–Ω—Ç –±—ç—Ö–ª—ç—Ö
    (async function bindExercise(){
      const { THREE } = await window.__depsReady;

      document.getElementById('btnExercise').addEventListener('click', () => {
        // overlay/–º–µ–Ω—é–≥ –±“Ø—Ä –º”©—Å”©–Ω —É–Ω—Ç—Ä–∞–∞–∂, AR-—Ç–∞–π —Ö–∞—Ä—å—Ü–∞—Ö –±–æ–ª–æ–º–∂ –Ω—ç—ç–Ω—ç
        wrap.style.display = 'none';
        menu.style.display = 'none';
        intro.pause(); exercise.pause();

        // Tracker –±–∞ anchor-–∞–∞ –Ω—ç–≥ —É–¥–∞–∞ –±—ç–ª–¥—å–µ
        if (!instantTracker) {
          // eslint-disable-next-line no-undef
          instantTracker = new window.ZapparThree.InstantWorldTracker();
          anchorGroup = new window.ZapparThree.InstantWorldAnchorGroup(camera, instantTracker);
          scene.add(anchorGroup);

          const tex = new THREE.VideoTexture(exercise);
          tex.colorSpace = THREE.SRGBColorSpace;

          function makePlane(){
            const w = exercise.videoWidth || 1280;
            const h = exercise.videoHeight || 720;
            const H = 0.7, W = H * (w / h);
            return new THREE.Mesh(
              new THREE.PlaneGeometry(W, H),
              new THREE.MeshBasicMaterial({ map: tex, transparent:true, side: THREE.DoubleSide })
            );
          }
          let plane = makePlane();
          plane.rotation.x = -Math.PI/2;
          anchorGroup.add(plane);

          exercise.addEventListener('loadedmetadata', ()=>{
            anchorGroup.remove(plane);
            plane.geometry.dispose(); plane.material.dispose();
            plane = makePlane();
            plane.rotation.x = -Math.PI/2;
            anchorGroup.add(plane);
          }, { once:true });

          // –≠—Ö–Ω–∏–π touch ‚Üí –±–∞–π—Ä–ª—É—É–ª–∂, –¥–∞—Å–≥–∞–ª—ã–Ω –≤–∏–¥–µ–æ–≥ –¥—É—É–≥–∞–∞—Ä —Ç–æ–≥–ª—É—É–ª–Ω–∞
          let placed = false;
          const onFirstTap = () => {
            placed = true;
            exercise.muted = false;
            exercise.currentTime = 0;
            exercise.play().catch(()=>{});
            removeEventListener('pointerdown', onFirstTap);
          };
          addEventListener('pointerdown', onFirstTap, { once:true, passive:true });

          // –±–∞–π—Ä–ª—É—É–ª—Ç–∞–ª –Ω—å ”©–º–Ω”© –Ω—å —Ç–æ–≥—Ç–º–æ–ª -2–º —É—Ä–¥ —Ç–∞–ª–¥ –±–∞—Ä–∏–Ω–∞
          const tick = () => { if (!placed) instantTracker.setAnchorPoseFromCameraOffset(0,0,-2); };
          // render loop-–¥ –∞–ª—å —Ö—ç–¥–∏–π–Ω –¥—É—É–¥–¥–∞–≥ —Ç—É–ª frame –±“Ø—Ä–¥ –∞–∂–∏–ª–ª—É—É–ª—ä—è
          (function hook(){ const orig = renderer.setAnimationLoop.bind(renderer);
            renderer.setAnimationLoop((...args)=>{ tick(); camera.updateFrame(renderer); renderer.render(scene, camera); });
            renderer.setAnimationLoop = orig; })();
        }
      });
    })();
  </script>
</body>
</html>
