<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro‚Üí–î–∞—Å–≥–∞–ª (Hotspots, Drag/Zoom on Exercise)</title>
  <style>
    :root { --z-cam:0; --z-video:2; --z-hot:4; --z-toast:5 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    /* –ö–∞–º–µ—Ä */
    #cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:var(--z-cam);transform:scaleX(-1)}

    /* –í–∏–¥–µ–æ–Ω—É—É–¥ */
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);display:none;touch-action:none}
    .overlay{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:contain;background:transparent;display:none;
      pointer-events:auto; transform-origin:center center; transform:translate(0,0) scale(1);
    }

    /* Hotspots ‚Äì –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞–π —Ç–æ–≤—á–Ω—É—É–¥ */
    #hotspots{position:fixed;inset:0;z-index:var(--z-hot);display:none;pointer-events:none}
    .hotbtn{
      position:absolute;transform:translate(-50%,-50%);
      pointer-events:auto;padding:12px 16px;border:0;border-radius:12px;
      background:#111;color:#fff;font-weight:700;font-size:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.28);opacity:0;animation:hotIn .25s ease forwards
    }
    .hotbtn.disabled{opacity:.55; filter:grayscale(1); pointer-events:none}
    @keyframes hotIn{from{opacity:0;transform:translate(-50%,-58%)}to{opacity:1;transform:translate(-50%,-50%)}}

    /* Autoplay —Å–∞–Ω—É—É–ª–≥–∞ */
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.72);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}

    /* –°–æ–Ω–≥–æ–ª—Ç–æ–æ—Ä reset (exercise –¥—ç—ç—Ä) */
    #reset{position:fixed;right:12px;bottom:20px;z-index:var(--z-hot);padding:10px 12px;border:0;border-radius:10px;background:#fff;color:#111;cursor:pointer;display:none}
  </style>
</head>
<body>
  <!-- –ö–∞–º–µ—Ä -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- –í–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- Hotspots -->
  <div id="hotspots"></div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  /* ====== –¢–∞–Ω—ã URL-—É—É–¥ ====== */
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

  /* ====== –≠–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥ ====== */
  const cam=document.getElementById('cam'), wrap=document.getElementById('overlay-wrap');
  const intro=document.getElementById('intro'), exercise=document.getElementById('exercise');
  const toast=document.getElementById('toast'), resetBtn=document.getElementById('reset');
  const hotspotLayer=document.getElementById('hotspots');

  /* ====== –ö–∞–º–µ—Ä (–∫–∞–ºe—Ä–≥“Ø–π PC –¥—ç—ç—Ä –±–æ–ª –∞–ª–¥–∞–∞–≥ –∑–∞–ª–≥–∏–∞–¥ “Ø—Ä–≥—ç–ª–∂–∏–ª–Ω—ç) ====== */
  async function startCamera(){
    try{
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
      cam.srcObject=s; await cam.play();
    }catch(e){
      console.warn('No camera, background hidden:', e.message);
      cam.style.display='none';
    }
  }

  /* ====== –í–∏–¥–µ–æ —ç—Ö —Å—É—Ä–≤–∞–ª–∂ ====== */
  function setSrc(el,url){ el.innerHTML=""; const s=document.createElement('source'); s.src=url; s.type='video/webm; codecs="vp8,opus"'; el.appendChild(s); }

  /* ====== Drag + Pinch-Zoom (–ó”®–í–•”®–ù exercise –¥—ç—ç—Ä) ====== */
  let active=null, scale=1, startScale=1, tx=0, ty=0, startX=0, startY=0, startDist=0;
  const dist=(a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
  function applyTransform(){ if(!active) return; active.style.transform=`translate(${tx}px, ${ty}px) scale(${scale})`; }
  function resetTransform(){ scale=1; tx=0; ty=0; applyTransform(); }
  function bindGesture(el){
    el.addEventListener('mousedown',e=>{ startX=e.clientX-tx; startY=e.clientY-ty;
      const mm=e2=>{ tx=e2.clientX-startX; ty=e2.clientY-startY; applyTransform(); };
      const mu=()=>{ window.removeEventListener('mousemove',mm); window.removeEventListener('mouseup',mu); };
      window.addEventListener('mousemove',mm); window.addEventListener('mouseup',mu);
    });
    el.addEventListener('touchstart',e=>{
      if(!active) return;
      if(e.touches.length===1){ startX=e.touches[0].clientX-tx; startY=e.touches[0].clientY-ty; }
      else if(e.touches.length===2){ startDist=dist(e.touches[0],e.touches[1]); startScale=scale; }
    },{passive:false});
    el.addEventListener('touchmove',e=>{
      if(!active) return; e.preventDefault();
      if(e.touches.length===1){ tx=e.touches[0].clientX-startX; ty=e.touches[0].clientY-startY; }
      else if(e.touches.length===2){ const d=dist(e.touches[0],e.touches[1]); scale=Math.max(0.5,Math.min(3,startScale*(d/startDist))); }
      applyTransform();
    },{passive:false});
  }
  // –¥–∞–≤—Ö–∞—Ä —Ç–æ–≤—à ‚Üí reset (exercise –¥—ç—ç—Ä –∞–∂–∏–ª–ª–∞–Ω–∞)
  wrap.addEventListener('click',(()=>{let t=0;return()=>{const n=Date.now(); if(n-t<300 && active===exercise) resetTransform(); t=n; };})());
  resetBtn.addEventListener('click',()=>{ if(active===exercise) resetTransform(); });

  /* ====== –ê—É–¥–∏–æ fallback ====== */
  async function playWithAudio(el){
    el.muted=false; el.volume=1.0;
    try{ await el.play(); toast.style.display='none'; }
    catch{ toast.style.display='block'; el.muted=true; el.play().catch(()=>{});
      const enable=()=>{ el.muted=false; el.volume=1.0; toast.style.display='none'; document.removeEventListener('pointerdown',enable,{passive:true}); };
      document.addEventListener('pointerdown',enable,{passive:true,once:true});
    }
  }

  /* ====== Hotspot —Å—Ü–µ–Ω–∞—Ä–∏–π–Ω –ñ–ò–®–≠–≠ ====== */
  // x,y ‚Äî %; start/end ‚Äî —Å–µ–∫—É–Ω–¥. Intro “Ø–µ–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞, –¥–∞—Ä–∂ –ë–û–õ–û–•–ì“Æ–ô.
  const INTRO_HOTSPOTS = [
    {start:3, end:6, items:[
      {id:'hsGuide', label:'–ó–∞–∞–≤–∞—Ä',   x:28, y:56, action:()=>alert('–ó–∞–∞–≤–∞—Ä!')}
    ]},
    {start:7.5, end:11, items:[
      {id:'hsInfo',  label:'–ú—ç–¥—ç—ç–ª—ç–ª', x:64, y:42, action:()=>alert('–ú—ç–¥—ç—ç–ª—ç–ª!')},
      {id:'hsGoEx',  label:'–î–∞—Å–≥–∞–ª —Ä—É—É', x:50, y:78, action:startExercise}
    ]}
  ];
  const EXERCISE_HOTSPOTS = [
    {start:5, end:9, items:[ {id:'hsBack', label:'–ë—É—Ü–∞—Ö', x:85, y:85, action:showIntroEndState} ]}
  ];

  let hotspotSpec=[], lastWindow=null, allowClicks=false;
  function clearHotspots(){ hotspotLayer.innerHTML=""; hotspotLayer.style.display="none"; lastWindow=null; }
  function renderHotspots(items){
    hotspotLayer.innerHTML=""; hotspotLayer.style.display="block";
    for(const it of items){
      const b=document.createElement('button');
      b.className='hotbtn' + (allowClicks ? '' : ' disabled');
      b.textContent=it.label; b.style.left=it.x+'%'; b.style.top=it.y+'%';
      if(allowClicks) b.onclick=(e)=>{ e.stopPropagation(); it.action && it.action(); };
      hotspotLayer.appendChild(b);
    }
  }
  function updateHotspots(t){
    const win = hotspotSpec.find(w=>t>=w.start && t<=w.end) || null;
    if(!win){ if(lastWindow) clearHotspots(); return; }
    if(lastWindow && win.start===lastWindow.start && win.end===lastWindow.end) return;
    lastWindow = win; renderHotspots(win.items);
  }
  function onTimeUpdate(){ updateHotspots(this.currentTime); }

  /* ====== –£—Ä—Å–≥–∞–ª ====== */
  async function boot(){
    await startCamera();
    setSrc(intro,INTRO_URL); setSrc(exercise,EXERCISE_URL);
    bindGesture(exercise);               // gesture –ó”®–í–•”®–ù exercise-–¥ —Ö–æ–ª–±–æ–ª–æ–æ

    wrap.style.display='block'; resetBtn.style.display='inline-block';

    // Intro: drag/zoom –∏–¥—ç–≤—Ö–≥“Ø–π (active=null), hotspot-—É—É–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞ —á –¥–∞—Ä–∂ –±–æ–ª–æ—Ö–≥“Ø–π
    active=null;
    intro.currentTime=0; intro.style.display='block';
    hotspotSpec=INTRO_HOTSPOTS; allowClicks=false; intro.addEventListener('timeupdate',onTimeUpdate);
    await playWithAudio(intro);
  }

  // Intro –¥—É—É—Å–º–∞–≥—Ü ‚Üí hotspot-—É—É–¥—ã–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—ç–¥ (–∫–ª–∏–∫ –±–æ–ª–æ–º–∂—Ç–æ–π) intro –∫–∞–¥—Ä—ã–≥ —Ö—ç–≤—ç—ç—Ä “Ø–ª–¥—ç—ç–Ω—ç
  function showIntroEndState(){
    intro.pause();
    allowClicks=true;                     // –æ–¥–æ–æ –¥–∞—Ä–∂ –±–æ–ª–Ω–æ
    if(lastWindow) renderHotspots(lastWindow.items); // —Ö–∞—Ä–∞–≥–¥–∞–∂ –±–∞–π—Å–∞–Ω —Ü–æ–Ω—Ö–æ–æ enable –±–æ–ª–≥–æ–Ω–æ
  }

  intro.addEventListener('ended', showIntroEndState);

  // –î–∞—Å–≥–∞–ª —ç—Ö–ª“Ø“Ø–ª—ç—Ö
  async function startExercise(){
    clearHotspots();
    exercise.currentTime=0; exercise.style.display='block';
    intro.style.display='none';
    active=exercise; resetTransform();    // –æ–¥–æ–æ drag/zoom –∞–∂–∏–ª–ª–∞–Ω–∞
    hotspotSpec=EXERCISE_HOTSPOTS; exercise.addEventListener('timeupdate',onTimeUpdate);
    await playWithAudio(exercise);
  }

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
