<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR + Zappar ‚Äî Intro‚Üí–ú–µ–Ω—é‚Üí–î–∞—Å–≥–∞–ª (Hotspots + Drag/Zoom)</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}
    :root{--z-ui:10;--z-toast:11}

    /* Zappar canvas */
    #zappar-canvas{position:fixed;inset:0;width:100vw;height:100vh;display:block;background:#000}

    /* HTML –≤–∏–¥–µ–æ–Ω—É—É–¥ ‚Äî –ü–õ–ï–ô–ë–≠–ö –ª —Ö–∏–π–∂, –¥—ç–ª–≥—ç—Ü—ç–Ω–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π */
    #overlay-wrap{display:none}
    .overlay{display:none}

    /* –¢”©–≤ –º–µ–Ω—é */
    #menu{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      z-index:var(--z-ui);pointer-events:none;background:none;animation:fadeIn .35s ease both;
    }
    .menu-inner{display:flex;flex-direction:column;gap:12px;pointer-events:auto;transform:translateY(18px);opacity:0;animation:slideUp .4s .05s ease-out both}
    .btn{width:200px;text-align:center;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;font-size:16px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    .btn:active{transform:translateY(1px)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(18px)}}

    /* Intro hotspot (display-only) */
    #hotspots{position:fixed;inset:0;z-index:var(--z-ui);display:none;pointer-events:none}
    .hotbtn{position:absolute;transform:translate(-50%,-50%);padding:10px 14px;border:0;border-radius:12px;background:rgba(17,17,17,.9);color:#fff;font-weight:700;font-size:14px;box-shadow:0 10px 24px rgba(0,0,0,.28);opacity:0;animation:hotIn .25s ease forwards;user-select:none}
    @keyframes hotIn{from{opacity:0;transform:translate(-50%,-58%)}to{opacity:1;transform:translate(-50%,-50%)}}

    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
    #reset{position:fixed;right:12px;bottom:20px;z-index:var(--z-ui);padding:10px 12px;border:0;border-radius:10px;background:#fff;color:#111;cursor:pointer;display:none}
  </style>
</head>
<body>
  <!-- Zappar WebGL canvas -->
  <canvas id="zappar-canvas"></canvas>

  <!-- –¢–∞–Ω—ã HTML VIDEOS: play/–¥—É—É–≥ —á–∏–Ω—å —ç–Ω–¥—ç—ç—Å —É–¥–∏—Ä–¥–∞–Ω–∞ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline crossorigin="anonymous"></video>
    <video id="exercise" class="overlay" playsinline loop crossorigin="anonymous"></video>
  </div>

  <!-- Intro “Ø–µ–∏–π–Ω —Ü–∞–≥—Ç–∞–π hotspots (display-only) -->
  <div id="hotspots"></div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

  <!-- Three.js + ZapparThree (CDN) -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://libs.zappar.com/zappar-threejs/2.3.1/zappar-threejs.min.js"></script>

<script>
/* ===== –¢–ê–ù–´ URL-—É—É–¥ ===== */
const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
// iOS fallback (HEVC + alpha) —Ñ–∞–π–ª—É—É–¥—ã–≥ —è–≥ —ç–Ω—ç –Ω—ç—Ä—à–ª—ç—ç—Ä –±–∞–π—Ä—à—É—É–ª—Å–∞–Ω –≥—ç–∂ “Ø–∑—å–µ:
const INTRO_URL_IOS    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.mp4"; // hvc1
const EXERCISE_URL_IOS = "https://batbaatar-anu.github.io/my-ar-host/dasgal.mp4";            // hvc1

/* ===== DOM ===== */
const canvas = document.getElementById('zappar-canvas');
const intro = document.getElementById('intro');
const exercise = document.getElementById('exercise');
const menu = document.getElementById('menu');
const btnExercise = document.getElementById('btnExercise');
const hotspotLayer = document.getElementById('hotspots');
const toast = document.getElementById('toast');
const resetBtn = document.getElementById('reset');

/* ===== –í–∏–¥–µ–æ–Ω–¥ —ç—Ö —Å—É—Ä–≤–∞–ª–∂ –æ–Ω–æ–æ—Ö (iOS fallback-—Ç–∞–π) ===== */
function setSources(videoEl, webmUrl, iosMp4Url){
  videoEl.innerHTML = "";

  // Android/Chrome (WebM + alpha)
  const s1 = document.createElement('source');
  s1.src = webmUrl;
  s1.type = 'video/webm; codecs="vp8,opus"';
  videoEl.appendChild(s1);

  // iOS Safari (HEVC + alpha)
  const s2 = document.createElement('source');
  s2.src = iosMp4Url;
  s2.type = 'video/mp4; codecs="hvc1"';
  videoEl.appendChild(s2);
}

/* ===== Zappar + Three.js setup ===== */
let renderer, scene, camera, instantTracker, anchor, plane, planeMat;
let activeVideo = null; // intro —ç—Å–≤—ç–ª exercise
let videoTexIntro, videoTexExercise;

async function initZappar(){
  // Browser capability —à–∞–ª–≥–∞—Ö (—Ö—ç—Ä—ç–≤ –±–æ–ª–æ–º–≥“Ø–π –±–æ–ª UI-–≥ –Ω—å “Ø–∑“Ø“Ø–ª—ç—ç–¥ –∑–æ–≥—Å–æ–æ–Ω–æ)
  if (ZapparThree.browserIncompatible()) {
    ZapparThree.browserIncompatibleUI();
    throw new Error('Browser incompatible');
  }

  // Camera permission UI
  const granted = await ZapparThree.permissionRequestUI();
  if (!granted) { ZapparThree.permissionDeniedUI(); throw new Error('Permission denied'); }

  renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);

  scene = new THREE.Scene();
  camera = new ZapparThree.Camera();
  scene.background = null;
  scene.add(camera);

  // –ö–∞–º–µ—Ä feed-–∏–π–≥ renderer-—Ç —Ö–æ–ª–±–æ—Ö
  ZapparThree.glContextSet(renderer.getContext());

  // !!! –ß–£–•–ê–õ: –ö–∞–º–µ—Ä—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö
  camera.start(); // –∞—Ä—ã–Ω –∫–∞–º–µ—Ä

  // Instant World Tracker (–¥—ç–ª—Ö–∏–π –¥—ç—ç—Ä —Ç–∞–≤–∏—Ö)
  instantTracker = new ZapparThree.InstantWorldTracker();
  anchor = new ZapparThree.InstantWorldAnchorGroup(camera, instantTracker);
  scene.add(anchor);

  // 3D plane ‚Äî –¥—ç—ç—Ä –Ω—å –≤–∏–¥–µ–æ —Ç–µ–∫—Å—Ç—É—Ä –Ω–∞–∞–Ω–∞
  const planeGeo = new THREE.PlaneGeometry(1, 1);

  videoTexIntro = new THREE.VideoTexture(intro);
  videoTexIntro.colorSpace = THREE.SRGBColorSpace;

  videoTexExercise = new THREE.VideoTexture(exercise);
  videoTexExercise.colorSpace = THREE.SRGBColorSpace;

  planeMat = new THREE.MeshBasicMaterial({
    map: videoTexIntro, transparent: true, side: THREE.DoubleSide
  });
  plane = new THREE.Mesh(planeGeo, planeMat);
  plane.scale.set(1.2, 1.2, 1); // –∞–Ω—Ö–Ω—ã —Ö—ç–º–∂—ç—ç
  anchor.add(plane);

  // Placement helper: 2–º —É—Ä–¥ —Ç–∞–ª–¥
  instantTracker.setAnchorPoseFromCameraOffset(0, 0, -2);

  window.addEventListener('resize', onResize);
  onResize();

  renderer.setAnimationLoop(()=> {
    camera.updateFrame(renderer);
    renderer.render(scene, camera);
  });
}

function onResize(){
  if (renderer && camera) {
    camera.resizeRendererToDisplaySize(renderer); // Zappar-–∏–π–Ω –∑”©–≤ —Ö—ç–º–∂—ç—ç—Å —Ç–∞–∞—Ä—É—É–ª–∞–≥—á
  }
}

/* ===== Drag + Pinch-Zoom ‚Üí 3D-plane-–¥ —Ö—ç—Ä—ç–≥–∂“Ø“Ø–ª—ç—Ö ===== */
let scale2d = 1, startScale = 1, tx = 0, ty = 0, sx = 0, sy = 0, startDist = 0;
const dist = (a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);

function applyPlaneTransform(){
  const k = 0.002; // –º—ç–¥—Ä—ç–º–∂
  plane.position.set(tx*k, -ty*k, 0);
  plane.scale.set(1.2*scale2d, 1.2*scale2d, 1);
}
function resetTransform(){
  scale2d = 1; tx = 0; ty = 0; applyPlaneTransform();
}
canvas.addEventListener('mousedown', e=>{
  sx = e.clientX - tx; sy = e.clientY - ty;
  const mm = e2 => { tx = e2.clientX - sx; ty = e2.clientY - sy; applyPlaneTransform(); };
  const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
  window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
});
canvas.addEventListener('touchstart', e=>{
  if (!activeVideo) return;
  if (e.touches.length===1){ sx = e.touches[0].clientX - tx; sy = e.touches[0].clientY - ty; }
  else if (e.touches.length===2){ startDist = dist(e.touches[0], e.touches[1]); startScale = scale2d; }
},{passive:false});
canvas.addEventListener('touchmove', e=>{
  if (!activeVideo) return; e.preventDefault();
  if (e.touches.length===1){ tx = e.touches[0].clientX - sx; ty = e.touches[0].clientY - sy; }
  else if (e.touches.length===2){ const d=dist(e.touches[0], e.touches[1]); scale2d = Math.max(0.5, Math.min(3, startScale*(d/startDist))); }
  applyPlaneTransform();
},{passive:false});
let lastTap=0;
canvas.addEventListener('click', ()=>{ const n=Date.now(); if(n-lastTap<300) resetTransform(); lastTap=n; });
resetBtn.addEventListener('click', resetTransform);

/* ===== Autoplay fallback ===== */
async function playWithAudio(el){
  el.muted = false; el.volume = 1.0;
  try { await el.play(); toast.style.display='none'; }
  catch {
    toast.textContent = "üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É";
    toast.style.display = "block";
    el.muted = true; el.play().catch(()=>{});
    const enable = ()=>{ el.muted=false; el.volume=1.0; toast.style.display='none'; document.removeEventListener('pointerdown', enable, {passive:true}); };
    document.addEventListener('pointerdown', enable, {passive:true, once:true});
  }
}

/* ===== Intro hotspot-—É—É–¥ (display only) ===== */
const INTRO_HOTSPOTS = [
  { start: 2.0, end: 4.5, items: [
    { id:'hs1', label:'–ó–∞–∞–≤–∞—Ä',   x:28, y:56 },
    { id:'hs2', label:'–ú—ç–¥—ç—ç–ª—ç–ª', x:64, y:42 }
  ]},
  { start: 7.0, end: 9.5, items: [
    { id:'hs3', label:'–î–∞—Ä–∞–∞—Ö –∞–ª—Ö–∞–º', x:50, y:78 }
  ]}
];
let hotspotSpec=[], lastWindow=null;
function clearHotspots(){ hotspotLayer.innerHTML=""; hotspotLayer.style.display="none"; lastWindow=null; }
function renderHotspots(items){
  hotspotLayer.innerHTML=""; hotspotLayer.style.display="block";
  for(const it of items){
    const b=document.createElement('div');
    b.className='hotbtn'; b.textContent=it.label;
    b.style.left=it.x+'%'; b.style.top=it.y+'%';
    hotspotLayer.appendChild(b);
  }
}
function updateHotspots(t){
  const win = hotspotSpec.find(w => t>=w.start && t<=w.end) || null;
  if(!win){ if(lastWindow) clearHotspots(); return; }
  if(lastWindow && win.start===lastWindow.start && win.end===lastWindow.end) return;
  lastWindow = win; renderHotspots(win.items);
}
function onIntroTime(){ updateHotspots(intro.currentTime); }

/* ===== –£—Ä—Å–≥–∞–ª ===== */
async function boot(){
  setSources(intro,    INTRO_URL,    INTRO_URL_IOS);
  setSources(exercise, EXERCISE_URL, EXERCISE_URL_IOS);

  await initZappar(); // –ö–∞–º–µ—Ä + 3D —Å—Ü–µ–Ω–∞

  // Intro —ç—Ö–ª“Ø“Ø–ª—ç—Ö (–≤–∏–¥–µ–æ–≥ plane –¥—ç—ç—Ä —Ö–æ–ª–±–æ–Ω–æ)
  activeVideo = intro;
  planeMat.map = videoTexIntro;
  planeMat.needsUpdate = true;

  hotspotSpec = INTRO_HOTSPOTS;
  intro.addEventListener('timeupdate', onIntroTime);

  resetBtn.style.display='inline-block';

  intro.currentTime = 0;
  await playWithAudio(intro);
}

/* ===== Intro –¥—É—É—Å–Ω–∞ ‚Üí –ú–µ–Ω—é –≥–∞—Ä–Ω–∞ (–ª–æ–≥–∏–∫ —Ö—ç–≤—ç—ç—Ä) ===== */
intro.addEventListener('ended', ()=>{
  clearHotspots();
  intro.removeEventListener('timeupdate', onIntroTime);
  activeVideo = null;
  menu.style.display = "flex";
});

/* ===== ‚Äú–î–∞—Å–≥–∞–ª‚Äù —Ç–æ–≤—á ===== */
btnExercise.addEventListener('click', async ()=>{
  menu.style.display = "none";
  // plane-–∏–π–≥ exercise –≤–∏–¥–µ–æ —Ä—É—É —à–∏–ª–∂“Ø“Ø–ª–Ω—ç
  planeMat.map = videoTexExercise;
  planeMat.needsUpdate = true;

  activeVideo = exercise;
  resetTransform();

  exercise.currentTime = 0;
  await playWithAudio(exercise);
});

window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
