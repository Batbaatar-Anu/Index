<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Zappar (Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª)</title>
  <style>
    :root { --z-cam:0; --z-canvas:10; --z-video:2; --z-menu:3; --z-toast:4; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    #cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:var(--z-cam);transform:scaleX(-1)}
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);display:block;touch-action:none}
    .overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:transparent;display:none}
    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu)}
    .menu-inner{display:flex;flex-direction:column;gap:12px}
    .btn{width:200px;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:6px;font:12px/1.2 monospace;white-space:pre-wrap;max-width:92vw}
    #httpsWarn{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:var(--z-debug);background:#141; color:#fff; padding:14px 16px; border-radius:12px; display:none}
  </style>
  <script>
    // —Ö—É—É—á–∏–Ω service worker –∫—ç—à –±–∞–π–≤–∞–ª —Å–∞–ª–≥–∞
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs=>rs.forEach(r=>r.unregister()));
    }
  </script>
</head>
<body>
  <div id="debug">DEBUG: booting‚Ä¶</div>
  <div id="httpsWarn">–≠–Ω—ç —Ö—É—É–¥–∞—Å HTTPS –±–∏—à —Ç—É–ª –∫–∞–º–µ—Ä/AR –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π.<br>Vercel/GitHub Pages —ç—Å–≤—ç–ª https —Ö”©–≥–∂“Ø“Ø–ª—ç–ª—Ç–∏–π–Ω —Å–µ—Ä–≤–µ—Ä –∞—à–∏–≥–ª–∞–∞—Ä–∞–π.</div>

  <!-- –≠—Ö–Ω–∏–π UI (intro ‚Üí –º–µ–Ω—é) -->
  <video id="cam" playsinline autoplay muted></video>

  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  const INTRO_URL        = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL     = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
  const MP4_EXERCISE_URL = ""; // iOS fallback —Ö—ç—Ä—ç–≥—Ç—ç–π –±–æ–ª —ç–Ω–¥ MP4

  const dbg = (m)=>{ document.getElementById('debug').textContent = 'DEBUG: ' + m; };

  const cam   = document.getElementById('cam');
  const wrap  = document.getElementById('overlay-wrap');
  const intro = document.getElementById('intro');
  const exercise = document.getElementById('exercise');
  const menu  = document.getElementById('menu');
  const toast = document.getElementById('toast');

  // === HTTPS —à–∞–ª–≥–∞–ª—Ç ===
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if (!isSecure) {
    document.getElementById('httpsWarn').style.display = 'block';
  }

  let audioCtx;
  async function ensureAudioFromStart(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return;
      if(!audioCtx) audioCtx = new Ctx();
      if(audioCtx.state === 'suspended'){ await audioCtx.resume().catch(()=>{}); }
    }catch(e){ dbg('AudioCtx err'); }
  }

  async function startCamera(){
    if (!isSecure) { dbg('skip getUserMedia (not https)'); return; }
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    cam.srcObject = stream; await cam.play();
    dbg('getUserMedia started');
  }
  async function stopCam(){
    try{
      if(cam.srcObject){ cam.srcObject.getTracks().forEach(t=>t.stop()); }
      cam.srcObject = null; cam.style.display = 'none';
      dbg('getUserMedia stopped');
    }catch(e){ dbg('stopCam err'); }
  }
  window.stopCam = stopCam;

  function setSources(videoEl, webmUrl, mp4Url=""){
    videoEl.innerHTML = "";
    videoEl.crossOrigin = "anonymous";
    videoEl.preload = "auto";
    if (webmUrl){ const s1=document.createElement('source'); s1.src=webmUrl; s1.type='video/webm; codecs="vp8,opus"'; videoEl.appendChild(s1); }
    if (mp4Url){ const s2=document.createElement('source'); s2.src=mp4Url; s2.type='video/mp4'; videoEl.appendChild(s2); }
    videoEl.load();
  }

  async function boot(){
    try{ await startCamera(); await ensureAudioFromStart(); }
    catch(err){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: " + err.message); dbg('boot fail'); return; }

    setSources(intro, INTRO_URL);
    setSources(exercise, EXERCISE_URL, MP4_EXERCISE_URL);

    intro.currentTime = 0; intro.style.display = "block"; intro.muted = false;
    try{ await intro.play(); toast.style.display = "none"; dbg('intro playing'); }
    catch(e){
      toast.style.display = "block"; intro.muted = true; intro.play().catch(()=>{});
      const enableAudio = ()=>{ intro.muted = false; toast.style.display = "none"; document.removeEventListener('pointerdown', enableAudio, {passive:true}); };
      document.addEventListener('pointerdown', enableAudio, {passive:true, once:true});
      dbg('intro autoplay blocked (tap to enable)');
    }
  }
  window.boot = boot;

  intro.addEventListener('ended', ()=>{ intro.style.display = "none"; menu.style.display = "flex"; dbg('intro ended ‚Üí menu'); });

  window.addEventListener('DOMContentLoaded', window.boot);
</script>

<!-- ======= three.js + Zappar (LOCAL ‚Üí CDN fallback) ======= -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

  // ZapparThree-–≥ –ª–æ–∫–∞–ª vendor ‚Üí CDN fallback-–∞–∞—Ä –∞—á–∞–∞–ª–Ω–∞
  async function loadZapparThree() {
    if (window.ZapparThree) return window.ZapparThree;
    const urls = [
      './vendor/zappar-threejs.js',
      'https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js',
      'https://cdn.jsdelivr.net/npm/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js',
      'https://libs.zappar.com/zappar-threejs/2.5.2/zappar-threejs.js'
    ];
    for (const url of urls) {
      try {
        await new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = url; s.async = false; s.onload = res; s.onerror = rej;
          document.head.appendChild(s);
        });
        if (window.ZapparThree) { document.getElementById('debug').textContent = 'DEBUG: Zappar loaded: ' + url; return window.ZapparThree; }
      } catch (e) {
        document.getElementById('debug').textContent = 'DEBUG: Zappar load fail: ' + url;
      }
    }
    alert('ZapparThree –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π. HTTPS –±–æ–ª–æ–Ω vendor —Ñ–∞–π–ª—É—É–¥–∞–∞ —à–∞–ª–≥–∞–∞—Ä–∞–π.');
    throw new Error('Zappar load failed');
  }

  // "–î–∞—Å–≥–∞–ª" ‚Üí AR —ç—Ö–ª“Ø“Ø–ª—ç—Ö
  document.getElementById('btnExercise').addEventListener('click', async () => {
    document.getElementById('menu').style.display = 'none';

    // overlay DOM-–≥ “Ø–ª–¥—ç—ç–Ω—ç (–≤–∏–¥–µ–æ–≥ texture –±–æ–ª–≥–æ–Ω–æ)
    const wrap = document.getElementById('overlay-wrap');
    wrap.style.visibility = 'hidden';
    wrap.style.pointerEvents = 'none';

    await window.stopCam();

    // HTTPS —à–∞–∞—Ä–¥–∞–Ω–∞
    if (!(location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
      document.getElementById('httpsWarn').style.display = 'block';
      document.getElementById('debug').textContent = 'DEBUG: AR blocked (not HTTPS)';
      return;
    }

    const ZapparThree = await loadZapparThree();

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    Object.assign(renderer.domElement.style, { position:'fixed', inset:'0', width:'100vw', height:'100vh', zIndex:'10', background:'transparent' });
    window.addEventListener('resize', ()=>renderer.setSize(window.innerWidth, window.innerHeight));

    ZapparThree.glContextSet(renderer.getContext());

    const camera = new ZapparThree.Camera({ userFacing:false });
    const scene  = new THREE.Scene();
    scene.background = camera.backgroundTexture;

    const granted = await ZapparThree.permissionRequest();
    if (!granted) { ZapparThree.permissionDeniedUI(); document.getElementById('debug').textContent = 'DEBUG: camera permission denied'; return; }
    camera.start();
    document.getElementById('debug').textContent = 'DEBUG: zappar camera started';

    const instantTracker = new ZapparThree.InstantWorldTracker();
    const anchorGroup = new ZapparThree.InstantWorldAnchorGroup(camera, instantTracker);
    scene.add(anchorGroup);

    const exerciseEl = document.getElementById('exercise');
    const tex = new THREE.VideoTexture(exerciseEl);
    tex.encoding = THREE.sRGBEncoding;

    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(1.2, 0.68),
      new THREE.MeshBasicMaterial({ map: tex, transparent:true, side: THREE.DoubleSide })
    );
    plane.rotation.x = -Math.PI/2;
    anchorGroup.add(plane);

    let placed = false;
    renderer.setAnimationLoop(()=>{
      if (!placed) instantTracker.setAnchorPoseFromCameraOffset(0, 0, -2);
      camera.updateFrame(renderer);
      renderer.render(scene, camera);
    });

    const onFirstTap = ()=>{
      placed = true;
      exerciseEl.muted = false;
      exerciseEl.currentTime = 0;
      exerciseEl.play().catch(()=>{});
      window.removeEventListener('pointerdown', onFirstTap);
      document.getElementById('debug').textContent = 'DEBUG: placed + playing';
    };
    window.addEventListener('pointerdown', onFirstTap, {once:true, passive:true});
  });
</script>
</body>
</html>
