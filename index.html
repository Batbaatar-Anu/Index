<!doctype html>
<html lang="mn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>WebXR AR ‚Äî World-Locked Alpha Video</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}
  /* –ú–µ–Ω—é ‚Äî –¥–æ–æ–¥ —Ç”©–≤–¥, –±–æ—Å–æ–æ —Ü—É–≤–∞–∞, –∞–Ω–∏–º—Ç–∞–π */
  #menu{
    position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;
    padding:28px;pointer-events:none;z-index:10;
    background:linear-gradient(to top, rgba(0,0,0,.35), rgba(0,0,0,0) 45%);
    animation: fadeIn .4s ease both;
  }
  .menu-inner{
    width:min(90vw,360px);display:flex;flex-direction:column;gap:12px;
    pointer-events:auto;transform:translateY(20px);animation: slideUp .35s .05s ease both;
  }
  .btn{
    padding:14px 18px;border:0;border-radius:14px;cursor:pointer;
    background:#fff;color:#111;font-weight:600;font-size:16px;
    box-shadow:0 8px 28px rgba(0,0,0,.25);transform:translateY(0);transition:transform .12s ease,opacity .2s;
    opacity:0;animation:itemIn .28s ease forwards;
  }
  .btn:nth-child(1){animation-delay:.08s}
  .btn:nth-child(2){animation-delay:.16s}
  .btn:nth-child(3){animation-delay:.24s}
  .btn:active{transform:translateY(1px)}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
  @keyframes itemIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  /* Toast */
  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);z-index:11;
    background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
  /* Fallback overlay */
  #fallback{position:fixed;inset:0;display:none;align-items:center;justify-content:center;color:#fff;z-index:12;padding:24px;text-align:center}
  /* Reticle */
  .reticle{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:64px;height:64px;border:2px solid rgba(255,255,255,.8);border-radius:50%;
    box-shadow:0 0 20px rgba(255,255,255,.35);opacity:0;transition:opacity .2s;
    pointer-events:none;z-index:9;
  }
</style>
</head>
<body>
<div id="menu">
  <div class="menu-inner">
    <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
    <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
    <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
  </div>
</div>
<div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>
<div id="fallback"><div>
  –≠–Ω—ç —Ç”©—Ö”©”©—Ä”©–º–∂ –¥—ç—ç—Ä World-AR (WebXR Hit-Test) –¥—ç–º–∂–∏–≥–¥—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.<br/>
  Android Chrome –¥—ç—ç—Ä —Ç—É—Ä—à–∏–∂ “Ø–∑–Ω—ç “Ø“Ø, —ç—Å–≤—ç–ª Zappar/8thWall –∞—à–∏–≥–ª–∞—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π (iOS-–¥). 
</div></div>
<div class="reticle" id="reticle"></div>

<script type="module">
/* ====== THREE + WebXR –º–æ–¥—É–ª–∏—É–¥ ====== */
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js";
import { ARButton } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/webxr/ARButton.js";

/* ====== –¢–∞–Ω—ã –≤–∏–¥–µ–æ URL-—É—É–¥ ====== */
const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
// (iOS fallback —Ö—ç—Ä—ç–≥ –±–æ–ª Zappar/8thWall —ç—Å–≤—ç–ª HEVC+hvc1 –±“Ø—Ö–∏–π ”©”©—Ä —à–∏–π–¥—ç–ª —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π)

/* ====== DOM ====== */
const menu = document.getElementById('menu');
const btnExercise = document.getElementById('btnExercise');
const toast = document.getElementById('toast');
const fallback = document.getElementById('fallback');
const reticleEl = document.getElementById('reticle');

/* ====== WebXR –±–æ–ª–æ–º–∂ —à–∞–ª–≥–∞—Ö ====== */
if (!navigator.xr || !(await navigator.xr.isSessionSupported?.("immersive-ar"))) {
  fallback.style.display = "flex";
} else {
  start();
}

async function start(){
  // --- Scene / Renderer ---
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  // –ì—ç—Ä—ç–ª (–±–∞–≥—Ü–∞–∞—Ä)
  const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
  scene.add(light);

  // --- AR Button (permission) ---
  const btn = ARButton.createButton(renderer, {
    requiredFeatures: ["hit-test"],  // –≥–∞–¥–∞—Ä–≥—É—É –∏–ª—Ä“Ø“Ø–ª—ç—Ö
    optionalFeatures: ["dom-overlay"],
    domOverlay: { root: document.body }
  });
  // ARButton –µ—Ä–¥–∏–π–Ω—Ö”©”©—Ä ”©”©—Ä”©”© button –≥–∞—Ä–≥–∞–¥–∞–≥ ‚Üí –±–∏–¥ UI-–≥ —Ü—ç–≤—ç—Ä—Ö—ç–Ω –±–∞–π–ª–≥–∞—Ö—ã–Ω —Ç—É–ª–¥ –Ω“Ø–¥–Ω—ç—ç—Å –¥–∞–ª–¥ –±–æ–ª–≥–æ—ë:
  btn.style.display = "none";
  document.body.appendChild(btn);

  // --- Hit Test —ç—Ö–ª“Ø“Ø–ª—ç—Ö ---
  const session = renderer.xr.getSession() || await navigator.xr.requestSession("immersive-ar", { requiredFeatures:["hit-test"], optionalFeatures:["dom-overlay"], domOverlay:{root:document.body} });
  renderer.xr.setSession(session);

  const viewerSpace = await session.requestReferenceSpace("viewer");
  const localSpace  = await session.requestReferenceSpace("local");
  const hitTestSrc  = await session.requestHitTestSource({ space: viewerSpace });

  // --- Reticle 3D (position-—Ç–æ–π mesh) ---
  const reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI/2),
    new THREE.MeshBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.9 })
  );
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // --- –í–∏–¥–µ–æ–Ω—É—É–¥ / –º–∞—Ç–µ—Ä–∏–∞–ª ---
  const introVideo = makeVideo(INTRO_URL, /*loop=*/false);
  const exerciseVideo = makeVideo(EXERCISE_URL, /*loop=*/true);

  const introTex = new THREE.VideoTexture(introVideo.el);
  introTex.colorSpace = THREE.SRGBColorSpace;
  const exerciseTex = new THREE.VideoTexture(exerciseVideo.el);
  exerciseTex.colorSpace = THREE.SRGBColorSpace;

  // Alpha-–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö
  const introMat = new THREE.MeshBasicMaterial({ map: introTex, transparent:true, side:THREE.DoubleSide });
  const exerciseMat = new THREE.MeshBasicMaterial({ map: exerciseTex, transparent:true, side:THREE.DoubleSide });

  // –í–∏–¥–µ–æ —Ö–∞–≤—Ç–≥–∞–π (–Ω–∏–π—Ç–ª—ç–≥ —Ö—ç–º–∂—ç—ç: 1–º ”©—Ä–≥”©–Ω, aspect-–∏–π–≥ –¥–∞—Ä–∞–∞ sync —Ö–∏–π–Ω—ç)
  const planeGeo = new THREE.PlaneGeometry(1.0, 0.5625); // 16:9 default
  const plane = new THREE.Mesh(planeGeo, introMat);
  plane.visible = false;
  scene.add(plane);

  // –í–∏–¥–µ–æ aspect-–∏–π–≥ –∂–∏–Ω—Ö—ç–Ω—ç —Ö—ç–º–∂—ç—ç–Ω–¥ —Ç–∞–∞—Ä—É—É–ª–∞—Ö
  const syncPlaneAspect = (vid, mesh) => {
    const w = vid.videoWidth || 16, h = vid.videoHeight || 9;
    const aspect = w / h;
    mesh.scale.set(1, 1/aspect, 1); // ”©—Ä–≥”©–Ω–∏–π–≥ 1–º –≥—ç–∂ “Ø–∑—ç—ç–¥ ”©–Ω–¥—Ä–∏–π–≥ aspect-–∞–∞—Ä —Ç–∞–∞—Ä—É—É–ª–Ω–∞
  };

  // --- Tap ‚Üí –æ–±—ä–µ–∫—Ç –±–∞–π—Ä–ª—É—É–ª–∞—Ö ---
  let placed = false;
  const onSelect = () => {
    if (!reticle.visible) return;
    placed = true;
    plane.visible = true;
    plane.matrix.fromArray(reticle.matrix.elements);
    plane.matrix.decompose(plane.position, plane.quaternion, plane.scale);

    // Intro-–≥ —Ç–æ–≥–ª—É—É–ª–∞—Ö (–¥—É—É—Ç–∞–π)
    playWithAudio(introVideo.el);

    // Intro –¥—É—É—Å–º–∞–≥—Ü ‚Üí –º–µ–Ω—é
    introVideo.el.onended = () => {
      menu.style.display = "flex";
    };
  };
  session.addEventListener("select", onSelect);

  // –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª
  btnExercise.addEventListener("click", async () => {
    menu.style.display = "none";
    plane.material = exerciseMat;
    playWithAudio(exerciseVideo.el);
  });

  // --- Render loop + hit test ---
  renderer.setAnimationLoop((t, frame) => {
    if (frame) {
      const results = frame.getHitTestResults(hitTestSrc);
      if (!placed && results.length) {
        const pose = results[0].getPose(localSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);
        reticleEl.style.opacity = 1; // HTML reticle
        // 3D reticle –±–∞–π—Ä
      } else if (!placed) {
        reticle.visible = false;
        reticleEl.style.opacity = 0;
      }
    }
    renderer.render(scene, camera);
  });

  // –¶–æ–Ω—Ö resize
  window.addEventListener('resize', () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // –í–∏–¥–µ–æ –¥—É—É–Ω—ã autoplay fallback
  function playWithAudio(videoEl){
    videoEl.muted = false;
    const tryPlay = async () => {
      try {
        await videoEl.play();
        toast.style.display = "none";
      } catch {
        toast.style.display = "block";
        videoEl.muted = true;
        videoEl.play().catch(()=>{});
        const enable = () => {
          videoEl.muted = false; videoEl.volume = 1.0;
          toast.style.display = "none";
          document.removeEventListener('pointerdown', enable, {passive:true});
        };
        document.addEventListener('pointerdown', enable, {passive:true, once:true});
      }
    };
    // aspect sync 1x —Ö–∏–π—á–∏—Ö—å–µ
    if (videoEl.readyState >= 2) syncPlaneAspect(videoEl, plane);
    else videoEl.addEventListener('loadedmetadata', () => syncPlaneAspect(videoEl, plane), {once:true});
    tryPlay();
  }

  function makeVideo(url, loop){
    const el = document.createElement('video');
    el.crossOrigin = "anonymous";
    el.playsInline = true;
    el.setAttribute('playsinline','');
    el.loop = !!loop;
    el.preload = "auto";
    // VP8 alpha
    const s1 = document.createElement('source');
    s1.src = url;
    s1.type = 'video/webm; codecs="vp8,opus"';
    el.appendChild(s1);
    return { el };
  }
}
</script>
</body>
</html>
