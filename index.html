<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR — Auto AR Experience (WebXR)</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20; --z-countdown:25 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25);transition:transform 0.2s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.95)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,0.8)}
    .menu-inner{display:flex;flex-direction:column;gap:16px;padding:20px;border-radius:20px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px)}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.7);
           padding:8px 12px;border-radius:8px;font:12px/1.4 monospace;white-space:pre-wrap;max-width:90vw;
           border:1px solid rgba(0,255,0,0.3)}

    #loadingScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:var(--z-ui);
                   background:#000;flex-direction:column;gap:20px}
    .loading-spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;
                     border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    #permissionError{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-ui);
                     background:#000;flex-direction:column;gap:20px;text-align:center;padding:20px}

    #countdownOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-countdown);
                      background:rgba(0,0,0,0.8);flex-direction:column;gap:20px}
    .countdown-number{font-size:120px;color:#fff;font-weight:bold;text-shadow:0 0 20px rgba(255,255,255,0.5);
                      animation:pulse 1s ease-in-out}
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
  </style>

  <!-- THREE only (no Zappar) -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
</head>
<body>
  <div id="debug">DEBUG: Initializing...</div>

  <div id="loadingScreen">
    <div class="loading-spinner"></div>
    <h2 style="color:#fff;margin:0;">Starting AR Experience...</h2>
    <p style="color:#ccc;margin:0;">Please allow camera access when prompted</p>
  </div>

  <div id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <p style="color:#fff;font-size:18px;margin:0;">Get ready for AR content...</p>
  </div>

  <div id="permissionError">
    <h2 style="color:#fff;margin-bottom:20px;">Camera Access Required</h2>
    <p style="color:#ccc;margin-bottom:30px;">This AR experience needs camera access to work properly.</p>
    <button id="btnRetry" class="btn">Try Again</button>
  </div>

  <button id="btnUnmute" class="btn">🔊 Enable Audio</button>

  <div id="menu">
    <div class="menu-inner">
      <h2 style="color:#fff;margin:0 0 10px 0;text-align:center;">Select Experience</h2>
      <button class="btn" id="btnExercise">Start Exercise</button>
      <button class="btn" id="btnRestart">Restart Intro</button>
    </div>
  </div>

  <!-- Hidden video elements -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

<script>
/********** Config **********/
const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
const INTRO_MP4_URL      = "";
const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
const EXERCISE_MP4_URL   = "";
const AR_POSITION = { x: 0, y: 0, z: -1.5 }; // урьдчилсан ойролцоо байрлал (placement хийгдээгүй үед)

const dbg = (m)=>{ console.log('DEBUG:', m); document.getElementById('debug').textContent='DEBUG: '+m; };

/********** DOM **********/
const vIntro = document.getElementById('vidIntro');
const vExercise = document.getElementById('vidExercise');
const loadingScreen = document.getElementById('loadingScreen');
const permissionError = document.getElementById('permissionError');
const countdownOverlay = document.getElementById('countdownOverlay');
const countdownNumber = document.getElementById('countdownNumber');
const btnRetry = document.getElementById('btnRetry');
const btnUnmute = document.getElementById('btnUnmute');
const menu = document.getElementById('menu');

/********** Helpers **********/
function setupVideoSources(videoElement, webmUrl, mp4Url="") {
  videoElement.innerHTML = "";
  if (webmUrl) {
    const s = document.createElement('source');
    s.src = webmUrl; s.type = 'video/webm; codecs="vp8,opus"';
    videoElement.appendChild(s);
  }
  if (mp4Url) {
    const s = document.createElement('source');
    s.src = mp4Url; s.type = 'video/mp4';
    videoElement.appendChild(s);
  }
  videoElement.setAttribute('webkit-playsinline','true');
  videoElement.setAttribute('playsinline','true');
  videoElement.preload = 'auto';
  videoElement.load();
}

async function showCountdown(seconds=3){
  return new Promise((resolve)=>{
    countdownOverlay.style.display='flex';
    let c=seconds; countdownNumber.textContent=c;
    const t=setInterval(()=>{
      c--;
      if(c>0){
        countdownNumber.textContent=c;
        countdownNumber.style.animation='none';
        setTimeout(()=>{countdownNumber.style.animation='pulse 1s ease-in-out'},10);
      }else{
        countdownNumber.textContent='GO!';
        setTimeout(()=>{ clearInterval(t); countdownOverlay.style.display='none'; resolve(); },1000);
      }
    },1000);
  });
}

function hideAllScreens(){
  loadingScreen.style.display='none';
  permissionError.style.display='none';
  countdownOverlay.style.display='none';
}
function showPermissionError(){
  loadingScreen.style.display='none';
  countdownOverlay.style.display='none';
  permissionError.style.display='flex';
}

function createVideoTexture(video){
  const tex = new THREE.VideoTexture(video);
  tex.colorSpace = THREE.SRGBColorSpace;
  tex.flipY = false;
  tex.minFilter = THREE.LinearFilter;
  tex.magFilter = THREE.LinearFilter;
  tex.generateMipmaps = false;
  return tex;
}

function adjustPlaneToVideo(video, plane){
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  const displayH = 0.8;
  const displayW = displayH * (w / h);
  plane.geometry.dispose();
  plane.geometry = new THREE.PlaneGeometry(displayW, displayH, 32, 32);
  dbg(`Optimized AR plane: ${displayW.toFixed(2)}x${displayH.toFixed(2)}`);
}

async function playVideoWithAudio(videoEl){
  try{
    if(videoEl.readyState < 2){
      await new Promise(res=>videoEl.addEventListener('canplay', res, { once:true }));
    }
    videoEl.muted = false;
    await videoEl.play();
    btnUnmute.style.display='none';
  }catch(e){
    videoEl.muted = true;
    try{
      await videoEl.play();
      btnUnmute.style.display='inline-block';
      dbg('Video playing muted - click unmute button');
    }catch(e2){
      dbg('Failed to play video: '+e2.message);
    }
  }
}

/********** Three.js + WebXR **********/
let renderer, scene, camera, plane, reticle;
let introTexture, exerciseTexture, currentVideo;
let xrSession, xrRefSpace, viewerSpace, hitTestSource;
let placed = false;

async function initThree(){
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:'high-performance' });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.domElement.classList.add('webgl');
  document.body.appendChild(renderer.domElement);
  renderer.xr.enabled = true;

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.01, 100);

  window.addEventListener('resize', ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
  });

  plane = new THREE.Mesh(
    new THREE.PlaneGeometry(1,1,16,16),
    new THREE.MeshBasicMaterial({ transparent:true, side:THREE.DoubleSide, alphaTest:0.1 })
  );
  plane.visible = false; // байрлуулаагүй үед
  scene.add(plane);

  // Reticle (цагираг)
  const ring = new THREE.RingGeometry(0.06,0.07,32);
  ring.rotateX(-Math.PI/2);
  reticle = new THREE.Mesh(ring, new THREE.MeshBasicMaterial());
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);
}

async function startXRSession(){
  if(!('xr' in navigator)) throw new Error('WebXR not supported in this browser');

  xrSession = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test','dom-overlay'],
    domOverlay: { root: document.body }
  });
  dbg('XR session started');

  await renderer.xr.setSession(xrSession);
  xrRefSpace = await xrSession.requestReferenceSpace('local');
  viewerSpace = await xrSession.requestReferenceSpace('viewer');
  hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

  // Товшилтоор объект байрлуулна
  window.addEventListener('click', ()=>{
    if(reticle.visible){
      placed = true;
      plane.visible = true;
      plane.matrix.copy(reticle.matrix);
      plane.matrix.decompose(plane.position, plane.quaternion, plane.scale);
    }
  });

  renderer.setAnimationLoop((t, frame)=>{
    if(!frame){ renderer.render(scene,camera); return; }
    const pose = frame.getViewerPose(xrRefSpace);
    if(!pose){ renderer.render(scene,camera); return; }

    const results = frame.getHitTestResults(hitTestSource);
    if(results.length > 0 && !placed){
      const hit = results[0];
      const hitPose = hit.getPose(xrRefSpace);
      reticle.visible = true;
      reticle.matrix.fromArray(hitPose.transform.matrix);
    }else if(!placed){
      reticle.visible = false;
    }

    renderer.render(scene, camera);
  });
}

/********** App flow **********/
async function startARExperience(){
  try{
    dbg('Starting enhanced AR experience...');

    // Видео эх үүсвэрүүд
    setupVideoSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
    setupVideoSources(vExercise, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

    introTexture    = introTexture    || createVideoTexture(vIntro);
    exerciseTexture = exerciseTexture || createVideoTexture(vExercise);

    currentVideo = vIntro;
    plane.material.map = introTexture;

    if (vIntro.readyState >= 1) adjustPlaneToVideo(vIntro, plane);
    else vIntro.addEventListener('loadedmetadata', ()=>adjustPlaneToVideo(vIntro, plane), { once:true });

    hideAllScreens();
    await showCountdown(3);

    await startXRSession();

    // Байршуулах хүртэл түр тогтоосон зайд харуулж болно (хүсвэл)
    if(!placed){
      plane.visible = true;
      plane.position.set(AR_POSITION.x, AR_POSITION.y, AR_POSITION.z);
    }

    await playVideoWithAudio(vIntro);
    dbg('High-quality intro video playing in AR');

    vIntro.onended = ()=>{
      menu.style.display='flex';
      dbg('Intro completed - showing menu');
    };

  }catch(error){
    console.error('Failed to start AR experience:', error);
    dbg('Failed to start: ' + error.message);
    showPermissionError();
  }
}

/********** UI events **********/
btnRetry.addEventListener('click', async ()=>{
  permissionError.style.display='none';
  loadingScreen.style.display='flex';
  try{
    await startARExperience();
  }catch(e){}
});

btnUnmute.addEventListener('click', async ()=>{
  if(currentVideo){
    try{
      currentVideo.muted=false;
      await currentVideo.play();
      btnUnmute.style.display='none';
      dbg('Audio enabled');
    }catch(e){
      dbg('Failed to enable audio: '+e.message);
    }
  }
});

document.getElementById('btnExercise').addEventListener('click', async ()=>{
  try{
    menu.style.display='none';
    dbg('Starting exercise...');

    if(currentVideo) currentVideo.pause();
    currentVideo = vExercise;
    plane.material.map = exerciseTexture;

    if (vExercise.readyState >= 1) adjustPlaneToVideo(vExercise, plane);
    else vExercise.addEventListener('loadedmetadata', ()=>adjustPlaneToVideo(vExercise, plane), { once:true });

    await showCountdown(3);
    vExercise.currentTime = 0;
    await playVideoWithAudio(vExercise);
    dbg('Exercise playing in high-quality AR');

  }catch(error){
    console.error('Failed to start exercise:', error);
    dbg('Failed to start exercise: ' + error.message);
  }
});

document.getElementById('btnRestart').addEventListener('click', async ()=>{
  try{
    menu.style.display='none';
    dbg('Restarting intro...');

    if(currentVideo) currentVideo.pause();
    currentVideo = vIntro;
    plane.material.map = introTexture;

    await showCountdown(2);
    vIntro.currentTime = 0;
    await playVideoWithAudio(vIntro);
    dbg('Intro restarted in high quality');

  }catch(error){
    console.error('Failed to restart intro:', error);
    dbg('Failed to restart: ' + error.message);
  }
});

/********** Boot **********/
window.addEventListener('load', async ()=>{
  try{
    await initThree();
    await startARExperience();
  }catch(e){
    console.error('Failed to initialize:', e);
    dbg('Initialization failed - check console');
    showPermissionError();
  }
});
</script>
</body>
</html>
