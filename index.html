<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Centered Menu + Drag/Zoom Video</title>
  <style>
    :root { --z-cam:0; --z-video:2; --z-ui:5; --z-toast:6 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    #cam{
      position:fixed; inset:0; width:100%; height:100%;
      object-fit:cover; background:#000; z-index:var(--z-cam);
      transform:scaleX(-1);
    }

    #overlay-wrap{
      position:fixed; inset:0; z-index:var(--z-video);
      display:none; touch-action:none; perspective:1000px;
    }

    .overlay{
      position:absolute; left:50%; top:55%;
      width:clamp(60vw, 72vw, 92vw);
      height:auto;
      transform:translate(-50%,-50%) rotateX(8deg) scale(1.15);
      transform-origin:center center;
      object-fit:contain; background:transparent; display:none; pointer-events:none;
      filter:drop-shadow(0 18px 40px rgba(0,0,0,.42));
      animation:popIn .45s ease both;
    }
    @keyframes popIn{
      from{opacity:0;transform:translate(-50%,-52%) rotateX(12deg) scale(.95)}
      to  {opacity:1;transform:translate(-50%,-50%) rotateX(8deg)  scale(1.15)}
    }

    /* –ú–µ–Ω—é ‚Äî –¥—ç–ª–≥—ç—Ü–∏–π–Ω —Ç”©–≤–¥ */
    #menu{
      position:fixed;
      top:50%; left:50%; transform:translate(-50%,-50%);
      display:none; flex-direction:column; align-items:center; gap:14px;
      z-index:var(--z-ui); pointer-events:auto;
    }
    .btn{
      width:180px; /* –±“Ø—Ö —Ç–æ–≤—á –∏–∂–∏–ª ”©—Ä–≥”©–Ω */
      padding:14px 20px; border:0; border-radius:12px; cursor:pointer;
      background:#fff; color:#111; font-weight:700; font-size:16px;
      text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }
    .btn:active{ transform:scale(0.98) }

    /* Autoplay —Å–∞–Ω—É—É–ª–≥–∞ */
    #toast{
      position:fixed; left:50%; top:14px; transform:translateX(-50%);
      z-index:var(--z-toast); background:rgba(0,0,0,.72); color:#fff;
      border-radius:10px; padding:10px 14px; font-size:13px; display:none
    }

    /* Scale controller */
    #ctrl{
      position:fixed; left:12px; bottom:16px; z-index:var(--z-ui);
      display:flex; gap:8px; align-items:center; background:rgba(17,17,17,.65);
      padding:8px; border-radius:12px; backdrop-filter: blur(6px);
    }
    #ctrl button{
      padding:8px 10px; border:0; border-radius:10px; background:#fff; color:#111;
      font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.25);
    }
    #scaleVal{ color:#fff; font-weight:700; min-width:54px; text-align:center }
  </style>
</head>
<body>
  <video id="cam" playsinline autoplay muted></video>

  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <div id="menu">
    <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª (Loop)</button>
    <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
    <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
  </div>

  <div id="ctrl">
    <button id="scaleMinus">‚àí</button>
    <div id="scaleVal">100%</div>
    <button id="scalePlus">+</button>
    <button id="scaleReset">Reset</button>
  </div>

  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

  const cam  = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro= document.getElementById('intro');
  const ex   = document.getElementById('exercise');
  const menu = document.getElementById('menu');
  const btnExercise = document.getElementById('btnExercise');
  const toast = document.getElementById('toast');

  async function startCamera(){
    const s = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }, audio:false
    });
    cam.srcObject = s; await cam.play();
  }

  function setVideo(el, url){
    el.innerHTML = "";
    const s = document.createElement('source');
    s.src = url; s.type = 'video/webm; codecs="vp8,opus"';
    el.appendChild(s);
  }

  let parallax = {x:0, y:0};
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', e=>{
      const nx = Math.max(-15, Math.min(15, e.gamma || 0)) / 15;
      const ny = Math.max(-15, Math.min(15, e.beta  || 0)) / 15;
      parallax.x = nx * 8; parallax.y = ny * 5;
      applyTransform();
    }, true);
  }

  let active=null, scale=1.15, startScale=1.15, tx=0, ty=0, sx=0, sy=0, startDist=0;
  function bounds(){
    const w = window.innerWidth, h = window.innerHeight;
    const limitX = Math.max(120, w * 0.35);
    const limitY = Math.max(140, h * 0.28);
    tx = Math.max(-limitX, Math.min(limitX, tx));
    ty = Math.max(-limitY, Math.min(limitY, ty));
    scale = Math.max(0.7, Math.min(2.4, scale));
  }
  function applyTransform(){
    if(!active) return; bounds();
    active.style.transform =
      `translate(calc(-50% + ${tx + parallax.x}px), calc(-50% + ${ty + parallax.y}px)) rotateX(8deg) scale(${scale})`;
  }
  function resetTransform(){
    scale = 1.15; tx = 0; ty = 0; applyTransform(); updateScaleLabel();
  }
  const dist=(a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);

  wrap.addEventListener('mousedown', e=>{
    sx = e.clientX - tx; sy = e.clientY - ty;
    const mm = e2 => { tx = e2.clientX - sx; ty = e2.clientY - sy; applyTransform(); };
    const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
  });
  wrap.addEventListener('touchstart', e=>{
    if(!active) return;
    if(e.touches.length===1){ sx=e.touches[0].clientX - tx; sy=e.touches[0].clientY - ty; }
    else if(e.touches.length===2){ startDist = dist(e.touches[0], e.touches[1]); startScale = scale; }
  }, {passive:false});
  wrap.addEventListener('touchmove', e=>{
    if(!active) return; e.preventDefault();
    if(e.touches.length===1){ tx = e.touches[0].clientX - sx; ty = e.touches[0].clientY - sy; }
    else if(e.touches.length===2){ const d = dist(e.touches[0], e.touches[1]); scale = startScale * (d/startDist); }
    applyTransform();
  }, {passive:false});
  let lastTap=0;
  wrap.addEventListener('click', ()=>{ const n=Date.now(); if(n-lastTap<300) resetTransform(); lastTap=n; });

  async function playWithAudio(el){
    el.muted=false;
    try{ await el.play(); toast.style.display='none'; }
    catch{
      toast.style.display='block'; el.muted=true; el.play().catch(()=>{});
      const enable=()=>{ el.muted=false; el.volume=1; toast.style.display='none';
        document.removeEventListener('pointerdown', enable, {passive:true}); };
      document.addEventListener('pointerdown', enable, {passive:true, once:true});
    }
  }

  async function boot(){
    try{ await startCamera(); } catch(e){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: "+e.message); return; }
    setVideo(intro, INTRO_URL);
    setVideo(ex,    EXERCISE_URL);
    wrap.style.display='block';
    active = intro; resetTransform();
    intro.currentTime=0; intro.loop=false; intro.style.display='block';
    await playWithAudio(intro);
  }

  intro.addEventListener('ended', ()=>{
    intro.style.display='none';
    active=null;
    menu.style.display='flex';
  });

  btnExercise.addEventListener('click', async ()=>{
    menu.style.display='none';
    ex.currentTime=0; ex.loop=true; ex.style.display='block';
    active = ex; resetTransform();
    await playWithAudio(ex);
  });

  // === Scale controller ===
  const ctrlMinus = document.getElementById('scaleMinus');
  const ctrlPlus  = document.getElementById('scalePlus');
  const ctrlReset = document.getElementById('scaleReset');
  const scaleVal  = document.getElementById('scaleVal');
  function updateScaleLabel(){ scaleVal.textContent = Math.round(scale*100) + '%'; }
  updateScaleLabel();
  function stepScale(delta){
    scale = Math.max(0.7, Math.min(2.4, scale + delta));
    applyTransform(); updateScaleLabel();
  }
  ctrlMinus.addEventListener('click', ()=> stepScale(-0.1));
  ctrlPlus .addEventListener('click', ()=> stepScale(+0.1));
  ctrlReset.addEventListener('click', ()=> resetTransform());

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
