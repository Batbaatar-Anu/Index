<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro‚Üí–ú–µ–Ω—é‚Üí–î–∞—Å–≥–∞–ª (Fixed AR Feel + Audio, Drag & Zoom)</title>
  <style>
    :root { --z-cam:0; --z-canvas:1; --z-video:2; --z-menu:3; --z-toast:4; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    /* –ö–∞–º–µ—Ä (–∞—Ä—ã–Ω) */
    #cam{
      position:fixed;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;z-index:var(--z-cam);
      transform:scaleX(-1);
    }

    /* Unity canvas (—Ö—ç—Ä—ç–≥–ª—ç–≤—ç–ª) */
    #unity-canvas{
      position:fixed;inset:0;width:100vw;height:100vh;
      background:transparent!important;z-index:var(--z-canvas);display:none;
    }

    /* 3D –º—ç–¥—Ä—ç–º–∂ ”©–≥”©—Ö”©–¥ perspective */
    #overlay-wrap{
      position:fixed;inset:0;z-index:var(--z-video);
      display:none; touch-action:none; perspective:1000px;
    }

    /* –ê–ª—å—Ñ–∞ –≤–∏–¥–µ–æ–Ω—É—É–¥ ‚Äî –¥—ç–ª–≥—ç—Ü–∏–π–Ω –¥–æ–æ–¥ —Ç”©–≤–¥ anchor-—Ç–∞–π (fixed AR feel) */
    .overlay{
      position:absolute; left:50%; top:70%;
      /* ”©—Ä–≥”©–Ω–∏–π–≥ –¥—ç–ª–≥—ç—Ü–∏–π–Ω ”©—Ä–≥”©–Ω”©”©—Ä —Ö—è–Ω–∞–∞–¥ ”©–Ω–¥”©—Ä”©”© —Ö–∞–¥–≥–∞–ª–Ω–∞ */
      width:60vw; max-width:800px; height:auto;
      transform:translate(-50%,-50%) rotateX(10deg) scale(1);
      transform-origin:center center;
      object-fit:contain; background:transparent; display:none;
      pointer-events:none;
      filter: drop-shadow(0 12px 30px rgba(0,0,0,.35)); /* –≥–∞–∑–∞—Ä—Ç –±—É—É—Å–∞–Ω –º—ç—Ç */
      animation: popIn .6s ease both;
    }
    @keyframes popIn{ from{ opacity:0; transform:translate(-50%,-40%) rotateX(16deg) scale(.8) } to{ opacity:1; transform:translate(-50%,-50%) rotateX(10deg) scale(1) } }

    /* –ú–µ–Ω—é ‚Äî –¥–æ–æ–¥ —Ç”©–≤–¥, –±–æ—Å–æ–æ —Ü—É–≤–∞–∞, stagger –∞–Ω–∏–º—Ç–∞–π */
    #menu{
      position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;
      padding:28px;pointer-events:none;z-index:var(--z-menu);
      background:linear-gradient(to top, rgba(0,0,0,.5), rgba(0,0,0,0) 45%);
      animation: fadeIn .5s ease both;
    }
    .menu-inner{
      width:min(90vw,360px); display:flex; flex-direction:column; gap:12px;
      pointer-events:auto; transform:translateY(20px); animation: slideUp .4s .1s ease both;
    }
    .btn{
      padding:14px 18px;border:0;border-radius:14px;cursor:pointer;
      background:#fff;color:#111;font-weight:600;font-size:16px;
      box-shadow:0 8px 28px rgba(0,0,0,.25); transform:translateY(0); transition:transform .12s ease, opacity .25s ease;
      opacity:0; animation: itemIn .35s ease forwards;
    }
    /* stagger */
    .btn:nth-child(1){ animation-delay:.12s }
    .btn:nth-child(2){ animation-delay:.20s }
    .btn:nth-child(3){ animation-delay:.28s }
    .btn:active{transform:translateY(1px)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
    @keyframes itemIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)}}

    /* –ñ–∏–∂–∏–≥ —Å–∞–Ω—É—É–ª–≥–∞ (autoplay policy) */
    #toast{
      position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);
      background:rgba(0,0,0,.72);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none
    }

    /* Placement mode badge */
    #badge{
      position:fixed; left:50%; bottom:92px; transform:translateX(-50%);
      background:rgba(0,0,0,.6); color:#fff; padding:8px 12px; border-radius:12px; font-size:12px;
      display:none; z-index:var(--z-menu)
    }

    /* Reset —Ç–æ–≤—á (—Å–æ–Ω–≥–æ–ª—Ç) */
    #reset{
      position:fixed;right:12px;bottom:20px;z-index:var(--z-menu);
      padding:10px 12px;border:0;border-radius:10px;background:#fff;color:#111;cursor:pointer;display:none;
    }
  </style>
</head>
<body>
  <!-- –ö–∞–º–µ—Ä -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- Unity canvas (—à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π –±–æ–ª –∞—à–∏–≥–ª–∞–∂ –±–æ–ª–Ω–æ) -->
  <canvas id="unity-canvas"></canvas>

  <!-- Gesture / 3D wrapper + –ê–ª—å—Ñ–∞ –≤–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- –ú–µ–Ω—é (intro –¥—É—É—Å—Å–∞–Ω—ã –¥–∞—Ä–∞–∞ –≥–∞—Ä–Ω–∞) -->
  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>
  <div id="badge">Placement mode ‚Äî drag / pinch ‚Üí tap to lock</div>

<script>
  // ================== –¢–ê–ù–´ –í–ò–î–ï–û URL-—É—É–¥ ==================
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
  // iOS fallback (—à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π –±–æ–ª —Ö–æ—ë—Ä –¥–∞—Ö—å source –±–∞–π–¥–ª–∞–∞—Ä –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª)
  // const INTRO_IOS    = "https://.../intro_alpha_hevc.mp4";    // type='video/mp4; codecs="hvc1"'
  // const EXERCISE_IOS = "https://.../exercise_alpha_hevc.mp4"; // type='video/mp4; codecs="hvc1"'

  const cam = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro = document.getElementById('intro');
  const exercise = document.getElementById('exercise');
  const menu = document.getElementById('menu');
  const btnExercise = document.getElementById('btnExercise');
  const toast = document.getElementById('toast');
  const resetBtn = document.getElementById('reset');
  const badge = document.getElementById('badge');

  // ===== –ö–∞–º–µ—Ä (–∞—Ä—ã–Ω) –∑”©–≤—à”©”©—Ä”©–ª ‚Üí —à—É—É–¥ –∞—Å–≥–∞—Ö
  async function startCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }, audio:false
    });
    cam.srcObject = stream;
    await cam.play();
  }

  // ===== –í–∏–¥–µ–æ–Ω–¥ —ç—Ö —Å—É—Ä–≤–∞–ª–∂ –æ–Ω–æ–æ—Ö
  function setSources(videoEl, webmUrl /*, hevcUrl */){
    videoEl.innerHTML = "";
    const s1 = document.createElement('source');
    s1.src = webmUrl;
    s1.type = 'video/webm; codecs="vp8,opus"';
    videoEl.appendChild(s1);
    // if (hevcUrl){ const s2=document.createElement('source'); s2.src=hevcUrl; s2.type='video/mp4; codecs="hvc1"'; videoEl.appendChild(s2); }
  }

  // ===== Placement / Transform (default: LOCKED) =====
  let active = null;                 // –∞–ª—å –≤–∏–¥–µ–æ –∏–¥—ç–≤—Ö—Ç—ç–π –≤—ç
  let locked = true;                 // –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä —Ç–æ–≥—Ç—Å–æ–Ω (drag/zoom –∏–¥—ç–≤—Ö–≥“Ø–π)
  let scale = 1, startScale = 1;
  let tx = 0, ty = 0, startX = 0, startY = 0;
  let startDist = 0;

  // anchor –±–∞–π—Ä–ª–∞–ª (–¥–æ–æ–¥ —Ç”©–≤): translate(-50%,-50%) rotateX(10deg) scale(1)
  // –±–∏–¥ –∑”©–≤—Ö”©–Ω translate-–¥ tx,ty-—ç—ç—Ä –Ω—ç–º—ç–ª—Ç —Ö”©–¥”©–ª–≥”©”©–Ω –æ—Ä—É—É–ª–Ω–∞
  function applyTransform(){
    if (!active) return;
    active.style.transform =
      `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) rotateX(10deg) scale(${scale})`;
  }
  function resetTransform(){
    scale = 1; tx = 0; ty = 0; applyTransform();
  }

  // Placement mode: long-press 600ms ‚Üí unlock; –Ω—ç–≥ –¥–∞—Ä–∞—Ö–∞–¥ lock
  let pressTimer = null;
  wrap.addEventListener('pointerdown', e=>{
    if (!active) return;
    pressTimer = setTimeout(()=>{
      locked = false;
      badge.style.display = 'block';
    }, 600);
  });
  wrap.addEventListener('pointerup', ()=>{
    clearTimeout(pressTimer);
  });
  wrap.addEventListener('click', ()=>{
    // placement –≥–æ—Ä–∏–º–¥ –±–∞–π—Ö–∞–¥ –Ω—ç–≥ —Ç–æ–≤—à–≤–æ–ª lock
    if (!locked){
      locked = true;
      badge.style.display = 'none';
    }
  });

  // mouse drag (placement mode-–¥ –ª –∞–∂–∏–ª–ª–∞–Ω–∞)
  wrap.addEventListener('mousedown', e=>{
    if (!active || locked) return;
    startX = e.clientX - tx; startY = e.clientY - ty;
    const mm = e2 => { tx = e2.clientX - startX; ty = e2.clientY - startY; applyTransform(); };
    const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
  });

  // touch drag + pinch (placement mode-–¥)
  wrap.addEventListener('touchstart', e=>{
    if (!active || locked) return;
    if (e.touches.length === 1){
      startX = e.touches[0].clientX - tx;
      startY = e.touches[0].clientY - ty;
    } else if (e.touches.length === 2){
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      startDist = Math.hypot(dx,dy);
      startScale = scale;
    }
  }, {passive:false});

  wrap.addEventListener('touchmove', e=>{
    if (!active || locked) return;
    e.preventDefault();
    if (e.touches.length === 1){
      tx = e.touches[0].clientX - startX;
      ty = e.touches[0].clientY - startY;
    } else if (e.touches.length === 2){
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const d = Math.hypot(dx,dy);
      scale = Math.max(0.2, Math.min(5, startScale * (d / startDist)));
    }
    applyTransform();
  }, {passive:false});

  resetBtn.addEventListener('click', ()=>{
    resetTransform();
    // –º”©–Ω –±–∞–π—Ä–ª–∞–ª—ã–≥ –¥–∞—Ö–∏–Ω center-–¥ lock-–æ–ª–∂ ”©–≥—å–µ
    locked = true; badge.style.display='none';
  });

  // ===== –£—Ä—Å–≥–∞–ª =====
  async function boot(){
    try{ await startCamera(); }
    catch(err){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: " + err.message); return; }

    wrap.style.display = "block";
    resetBtn.style.display = "inline-block";

    // Intro-–≥ “Ø—Ä–≥—ç–ª–∂ —Ç–æ–≥–ª—É—É–ª–Ω–∞ (–±–æ–ª–≥–æ–Ω—ã “Ø–µ–¥)
    setSources(intro, INTRO_URL /*, INTRO_IOS*/);
    active = intro; locked = true; resetTransform();
    intro.muted = false; intro.currentTime = 0; intro.style.display = "block";

    try{ await intro.play(); }
    catch(e){
      toast.style.display = "block";
      intro.muted = true;
      intro.play().catch(()=>{});
      const enableAudio = ()=>{
        intro.muted = false; intro.volume = 1.0;
        toast.style.display = "none";
        document.removeEventListener('pointerdown', enableAudio, {passive:true});
      };
      document.addEventListener('pointerdown', enableAudio, {passive:true, once:true});
    }
  }

  // Intro –¥—É—É—Å–º–∞–≥—Ü ‚Üí –º–µ–Ω—é –∫–∞–º–µ—Ä—ã–Ω –¥—ç—ç—Ä
  intro.addEventListener('ended', ()=>{
    intro.style.display = "none";
    active = null;
    menu.style.display = "flex";
  });

  // ‚Äú–î–∞—Å–≥–∞–ª‚Äù —Ç–æ–≤—á ‚Üí exercise alpha (loop)
  btnExercise.addEventListener('click', async ()=>{
    menu.style.display = "none";
    setSources(exercise, EXERCISE_URL /*, EXERCISE_IOS*/);
    active = exercise; locked = true; resetTransform();
    exercise.muted = false; exercise.currentTime = 0; exercise.style.display = "block";
    try{ await exercise.play(); }
    catch(e){
      toast.style.display = "block";
      exercise.muted = true;
      exercise.play().catch(()=>{});
      const enableAudio2 = ()=>{
        exercise.muted = false; exercise.volume = 1.0;
        toast.style.display = "none";
        document.removeEventListener('pointerdown', enableAudio2, {passive:true});
      };
      document.addEventListener('pointerdown', enableAudio2, {passive:true, once:true});
    }
  });

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
