<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Realistic Overlay (Center Menu, Drag & Zoom)</title>
  <style>
    :root { --z-cam:0; --z-video:2; --z-menu:5; --z-toast:6; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    /* –ö–∞–º–µ—Ä (–∞—Ä—ã–Ω) */
    #cam{
      position:fixed; inset:0; width:100%; height:100%;
      object-fit:cover; background:#000; z-index:var(--z-cam);
      transform:scaleX(-1);
    }

    /* 3D –º—ç–¥—Ä—ç–º–∂ ”©–≥”©—Ö –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤ wrapper */
    #overlay-wrap{
      position:fixed; inset:0; z-index:var(--z-video);
      display:none; touch-action:none; perspective:1000px;
    }

    /* –ê–ª—å—Ñ–∞ –≤–∏–¥–µ–æ ‚Äì –¥–æ–æ–¥-—Ç”©–≤ anchor + tilt + shadow */
    .overlay{
      position:absolute; left:50%; top:72%;
      width:clamp(38vw,58vw,75vw); height:auto;
      transform:translate(-50%,-50%) rotateX(11deg) scale(1);
      transform-origin:center center; object-fit:contain;
      background:transparent; display:none; pointer-events:none;
      filter:drop-shadow(0 14px 34px rgba(0,0,0,.38));
      animation:popIn .55s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes popIn{
      from{opacity:0;transform:translate(-50%,-40%) rotateX(16deg) scale(.86)}
      to  {opacity:1;transform:translate(-50%,-50%) rotateX(11deg) scale(1)}
    }

    /* –¢”©–≤ –º–µ–Ω—é (slide-down) */
    #menu{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:var(--z-menu); pointer-events:none;
      background:radial-gradient(120% 120% at 50% 100%, rgba(0,0,0,.45), rgba(0,0,0,0) 60%);
    }
    .menu-card{
      width:min(92vw,420px); display:flex; flex-direction:column; gap:12px; padding:18px;
      background:rgba(255,255,255,.94); border-radius:18px; pointer-events:auto;
      box-shadow:0 24px 50px rgba(0,0,0,.35);
      transform:translateY(-16px); opacity:0; animation:drop .45s ease-out forwards;
    }
    .menu-title{font-weight:800;font-size:18px;color:#0f172a;text-align:center;margin-bottom:4px}
    .btn{padding:14px 18px;border:0;border-radius:12px;cursor:pointer;background:#111827;color:#fff;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .btn.alt{background:#e5e7eb;color:#111}
    .row{display:flex;gap:10px}
    @keyframes drop{from{opacity:0;transform:translateY(-24px)}to{opacity:1;transform:translateY(0)}}

    /* Autoplay —Å–∞–Ω—É—É–ª–≥–∞ */
    #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.72);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
  </style>
</head>
<body>
  <!-- –ö–∞–º–µ—Ä -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- –ê–ª—å—Ñ–∞ –≤–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- –¢”©–≤ –º–µ–Ω—é -->
  <div id="menu">
    <div class="menu-card">
      <div class="menu-title">–î–∞—Ä–∞–∞–≥–∏–π–Ω –∞–ª—Ö–∞–º</div>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª (Loop)</button>
      <div class="row">
        <button class="btn alt" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
        <button class="btn alt" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      </div>
    </div>
  </div>

  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  // ===== –í–∏–¥–µ–æ URL-—É—É–¥ =====
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
  // iOS –±–æ–ª —Å–æ–Ω–≥–æ–ª—Ç–æ–æ—Ä HEVC+hvc1 source-—ã–≥ —Ö–æ—ë—Ä –¥–∞—Ö—å <source> –±–∞–π–¥–ª–∞–∞—Ä –Ω—ç–º—ç—ç—Ä—ç–π.

  const cam  = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro= document.getElementById('intro');
  const ex   = document.getElementById('exercise');
  const menu = document.getElementById('menu');
  const btnExercise = document.getElementById('btnExercise');
  const toast = document.getElementById('toast');

  // –ö–∞–º–µ—Ä
  async function startCamera(){
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    cam.srcObject = s; await cam.play();
  }

  // –í–∏–¥–µ–æ —ç—Ö —Å—É—Ä–≤–∞–ª–∂
  function setVideo(el, url){
    el.innerHTML = "";
    const s = document.createElement('source');
    s.src = url; s.type = 'video/webm; codecs="vp8,opus"';
    el.appendChild(s);
  }

  // –ë–∞–≥–∞—Ö–∞–Ω gyro parallax
  let parallax = {x:0, y:0};
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', e=>{
      const nx = Math.max(-15, Math.min(15, e.gamma || 0)) / 15;
      const ny = Math.max(-15, Math.min(15, e.beta  || 0)) / 15;
      parallax.x = nx * 10; parallax.y = ny * 6; applyTransform();
    }, true);
  }

  // Drag + Zoom (bounded)
  let active=null, scale=1, startScale=1, tx=0, ty=0, sx=0, sy=0, startDist=0;
  const clamp = () => {
    const w = Math.min(window.innerWidth, 800);
    const limitX = w*0.25, limitY = 120;
    tx = Math.max(-limitX, Math.min(limitX, tx));
    ty = Math.max(-limitY, Math.min(limitY, ty));
    scale = Math.max(0.85, Math.min(1.6, scale));
  };
  function applyTransform(){
    if(!active) return; clamp();
    active.style.transform =
      `translate(calc(-50% + ${tx + parallax.x}px), calc(-50% + ${ty + parallax.y}px)) rotateX(11deg) scale(${scale})`;
  }
  function resetTransform(){ scale=1; tx=0; ty=0; applyTransform(); }

  wrap.addEventListener('mousedown', e=>{
    sx = e.clientX - tx; sy = e.clientY - ty;
    const mm = e2 => { tx = e2.clientX - sx; ty = e2.clientY - sy; applyTransform(); };
    const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
  });
  wrap.addEventListener('touchstart', e=>{
    if(!active) return;
    if(e.touches.length===1){ sx=e.touches[0].clientX - tx; sy=e.touches[0].clientY - ty; }
    else if(e.touches.length===2){ startDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); startScale = scale; }
  }, {passive:false});
  wrap.addEventListener('touchmove', e=>{
    if(!active) return; e.preventDefault();
    if(e.touches.length===1){ tx = e.touches[0].clientX - sx; ty = e.touches[0].clientY - sy; }
    else if(e.touches.length===2){
      const d = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
      scale = startScale * (d/startDist);
    }
    applyTransform();
  }, {passive:false});
  let lastTap=0;
  wrap.addEventListener('click', ()=>{ const n=Date.now(); if(n-lastTap<300) resetTransform(); lastTap=n; });

  // –ê—É–¥–∏–æ autoplay fallback
  async function playWithAudio(el){
    el.muted=false;
    try{ await el.play(); toast.style.display='none'; }
    catch{
      toast.style.display='block'; el.muted=true; el.play().catch(()=>{});
      const enable=()=>{ el.muted=false; el.volume=1; toast.style.display='none'; document.removeEventListener('pointerdown', enable, {passive:true}); };
      document.addEventListener('pointerdown', enable, {passive:true, once:true});
    }
  }

  // –£—Ä—Å–≥–∞–ª
  async function boot(){
    try{ await startCamera(); } catch(e){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: "+e.message); return; }
    setVideo(intro, INTRO_URL); setVideo(ex, EXERCISE_URL);
    wrap.style.display='block';
    active = intro; resetTransform();
    intro.currentTime=0; intro.loop=false; intro.style.display='block';
    await playWithAudio(intro);
  }
  intro.addEventListener('ended', ()=>{ intro.style.display='none'; active=null; menu.style.display='flex'; });
  btnExercise.addEventListener('click', async ()=>{
    menu.style.display='none';
    ex.currentTime=0; ex.loop=true; ex.style.display='block';
    active = ex; resetTransform(); await playWithAudio(ex);
  });

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
