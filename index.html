<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro‚Üí–ú–µ–Ω—é‚Üí–î–∞—Å–≥–∞–ª (Zappar Instant World Tracking)</title>
  <style>
    :root { --z-cam:0; --z-canvas:1; --z-video:2; --z-menu:3; --z-toast:4; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}
    #cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:var(--z-cam);transform:scaleX(-1)}
    #unity-canvas{position:fixed;inset:0;width:100vw;height:100vh;background:transparent!important;z-index:var(--z-canvas);display:none}
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);display:none;touch-action:none}
    .overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:transparent;display:none;pointer-events:auto;transform-origin:center center;transform:translate(0px,0px) scale(1)}
    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);pointer-events:none;background:none;animation:fadeIn .35s ease both}
    .menu-inner{display:flex;flex-direction:column;gap:12px;pointer-events:auto;transform:translateY(18px);opacity:0;animation:slideUp .4s .05s ease-out both}
    .btn{width:200px;text-align:center;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;font-size:16px;box-shadow:0 8px 28px rgba(0,0,0,.25);transform:translateY(0);transition:transform .15s ease}
    .btn:active{transform:translateY(1px)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(18px)}}
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
    #reset{position:fixed;right:12px;bottom:20px;z-index:var(--z-menu);padding:10px 12px;border:0;border-radius:10px;background:#fff;color:#111;cursor:pointer;display:none}
  </style>
</head>
<body>
  <!-- –¢–∞–Ω–∞–π —ç—Ö–Ω–∏–π –∫–∞–º–µ—Ä + –∏–Ω—Ç—Ä–æ/–≤–∏–¥–µ–æ UI (intro –¥—É—É—Å–∞–∞–¥ –º–µ–Ω—é –≥–∞—Ä–Ω–∞) -->
  <video id="cam" playsinline autoplay muted></video>
  <canvas id="unity-canvas"></canvas>

  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

  const cam = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro = document.getElementById('intro');
  const exercise = document.getElementById('exercise');
  const menu = document.getElementById('menu');
  const toast = document.getElementById('toast');
  const resetBtn = document.getElementById('reset');

  let audioCtx;
  async function ensureAudioFromStart(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return;
      if(!audioCtx) audioCtx = new Ctx();
      if(audioCtx.state === 'suspended'){ await audioCtx.resume().catch(()=>{}); }
    }catch(e){}
  }

  async function startCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    cam.srcObject = stream; await cam.play();
  }
  async function stopCam(){
    try{
      if(cam.srcObject){ cam.srcObject.getTracks().forEach(t=>t.stop()); }
      cam.srcObject = null; cam.style.display = 'none';
    }catch(e){}
  }

  function setSources(videoEl, webmUrl){
    videoEl.innerHTML = "";
    const s1 = document.createElement('source');
    s1.src = webmUrl;
    s1.type = 'video/webm; codecs="vp8,opus"';
    videoEl.appendChild(s1);
  }

  async function boot(){
    try{ await startCamera(); await ensureAudioFromStart(); }
    catch(err){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: " + err.message); return; }
    setSources(intro, INTRO_URL);
    setSources(exercise, EXERCISE_URL);
    wrap.style.display = "block";
    resetBtn.style.display = "inline-block";
    intro.currentTime = 0; intro.style.display = "block"; intro.muted = false; intro.volume = 1.0;
    try{ await intro.play(); toast.style.display = "none"; }
    catch(e){
      toast.textContent = "üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É";
      toast.style.display = "block";
      intro.muted = true; intro.play().catch(()=>{});
      const enableAudio = ()=>{ intro.muted = false; intro.volume = 1.0; toast.style.display = "none"; document.removeEventListener('pointerdown', enableAudio, {passive:true}); };
      document.addEventListener('pointerdown', enableAudio, {passive:true, once:true});
    }
  }
  intro.addEventListener('ended', ()=>{ intro.style.display = "none"; menu.style.display = "flex"; });
</script>

<!-- 1) Zappar THREE.js (CDN) -->
<script src="https://libs.zappar.com/zappar-threejs/2.5.2/zappar-threejs.js"></script>
<!-- 2) three.js (ESM) + Zappar AR –∫–æ–¥ -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

  const ZapparThree = window.ZapparThree; // CDN-–∞–∞—Å –≥–ª–æ–±–∞–ª

  let renderer, scene, camera, instantTracker, anchorGroup, videoMesh, placed = false;

  function makeRenderer(){
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    Object.assign(renderer.domElement.style, { position:'fixed', inset:'0', width:'100vw', height:'100vh', zIndex:'1', background:'transparent' });
    window.addEventListener('resize', ()=>renderer.setSize(window.innerWidth, window.innerHeight));
  }

  async function startZapparAR(){
    makeRenderer();

    // Zappar-–¥ WebGL context-—ç—ç ”©–≥–Ω”©
    ZapparThree.glContextSet(renderer.getContext());

    // Zappar camera (backgroundTexture = device camera feed)
    camera = new ZapparThree.Camera();
    scene  = new THREE.Scene();
    scene.background = camera.backgroundTexture;

    // Permission UI ‚Üí –∫–∞–º–µ—Ä –∞—Å–∞–∞—Ö
    const granted = await ZapparThree.permissionRequest();
    if(!granted){ ZapparThree.permissionDeniedUI(); return; }
    camera.start();  // –∞—Ä—ã–Ω –∫–∞–º–µ—Ä

    // Instant World Tracking
    instantTracker = new ZapparThree.InstantWorldTracker();
    anchorGroup    = new ZapparThree.InstantWorldAnchorGroup(camera, instantTracker);
    scene.add(anchorGroup); // –≠–Ω—ç group –¥—ç—ç—Ä—ç—ç –∫–æ–Ω—Ç–µ–Ω—Ç–æ–æ –Ω—ç–º–Ω—ç. :contentReference[oaicite:2]{index=2}

    // –¢–∞–Ω–∞–π exercise –≤–∏–¥–µ–æ–≥ 3D-plane –¥—ç—ç—Ä –Ω–∞–∞–Ω–∞
    const exerciseEl = document.getElementById('exercise');
    const tex = new THREE.VideoTexture(exerciseEl);
    tex.encoding = THREE.sRGBEncoding;

    const planeGeo = new THREE.PlaneGeometry(1.2, 0.68); // (–º–µ—Ç—Ä—ç—ç—Ä) —Ö“Ø—Å–≤—ç–ª ”©”©—Ä—á–∏–ª–∂ –±–æ–ª–Ω–æ
    const planeMat = new THREE.MeshBasicMaterial({ map: tex, transparent:true, side: THREE.DoubleSide });
    videoMesh = new THREE.Mesh(planeGeo, planeMat);
    videoMesh.rotation.x = -Math.PI/2; // –≥–∞–∑–∞—Ä –ª—É—É –ø–∞—Ä–∞–ª–ª–µ–ª—å
    anchorGroup.add(videoMesh);

    // Loop: –±–∞–π—Ä–ª—É—É–ª—Ç–∞–ª —è–∫–æ—Ä–æ–æ –∫–∞–º–µ—Ä—ã–Ω ”©–º–Ω”© –±–∞—Ä–∏–Ω–∞
    function animate(){
      requestAnimationFrame(animate);
      if(!placed) instantTracker.setAnchorPoseFromCameraOffset(0, 0, -2); // –¥—ç–ª–≥—ç—Ü–∏–π–Ω ”©–º–Ω”© ~2–º :contentReference[oaicite:3]{index=3}
      camera.updateFrame(renderer);
      renderer.render(scene, camera);
    }
    animate();

    // –≠—Ö–Ω–∏–π —Ç–æ–≤—à–∏–ª—Ç–æ–æ—Ä "place + unmute + play"
    const onFirstTap = ()=>{
      placed = true;
      exerciseEl.muted = false;
      exerciseEl.currentTime = 0;
      exerciseEl.play().catch(()=>{});
      window.removeEventListener('pointerdown', onFirstTap);
    };
    window.addEventListener('pointerdown', onFirstTap, {once:true, passive:true});
  }

  // "–î–∞—Å–≥–∞–ª" –¥—ç—ç—Ä –¥–∞—Ä–º–∞–≥—Ü: UI-–≥–∞–∞ –Ω—É—É–∂, getUserMedia-–≥ —Ö–∞–∞–≥–∞–∞–¥ Zappar AR —ç—Ö–ª“Ø“Ø–ª–Ω—ç
  document.getElementById('btnExercise').addEventListener('click', async ()=>{
    document.getElementById('menu').style.display = 'none';
    document.getElementById('overlay-wrap').style.display = 'none';
    await window.stopCam();
    await startZapparAR();
  });

  // –≠—Ö–Ω–∏–π –∞—á–∞–∞–ª–∞–ª—Ç (–∏–Ω—Ç—Ä–æ —Ç–æ–≥–ª–æ–æ–¥ ‚Üí –º–µ–Ω—é)
  window.addEventListener('DOMContentLoaded', window.boot);
</script>
</body>
</html>
