<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    #startLayer{position:fixed;inset:0;display:grid;place-items:center;z-index:var(--z-ui);background:#000}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu)}
    .menu-inner{display:flex;flex-direction:column;gap:12px}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);
           padding:6px 8px;border-radius:6px;font:12px/1.2 monospace;white-space:pre-wrap;max-width:90vw}
  </style>

  <!-- THREE + Zappar -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: booting‚Ä¶</div>

  <!-- UI -->
  <div id="startLayer"><button id="btnStart" class="btn">‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–•</button></div>
  <button id="btnUnmute" class="btn">üîä –î—É—É–≥ –∞—Å–∞–∞—Ö</button>
  <div id="menu"><div class="menu-inner">
    <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
  </div></div>

  <!-- –ù—É—É—Ü <video> (AR —Ç–µ–∫—Å—Ç—É—Ä—Ç –æ—Ä–Ω–æ) -->
  <video id="vidIntro" playsinline preload="auto" style="display:none"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none"></video>

  <script>
    /********** –¢–æ—Ö–∏—Ä–≥–æ–æ **********/
    // iOS-–¥ WebM+alpha —Ç–æ–≥–ª–æ—Ö–≥“Ø–π —Ç—É–ª MP4 fallback (–∞–ª—å—Ñ–∞-–≥“Ø–π) —Ö“Ø—Å–≤—ç–ª —ç–Ω–¥ URL —Ç–∞–≤—å–∂ –±–æ–ª–Ω–æ.
    const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL      = "";
    const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL   = "";

    const dbg = (m)=>document.getElementById('debug').textContent = 'DEBUG: ' + m;

    const vIntro   = document.getElementById('vidIntro');
    const vEx      = document.getElementById('vidExercise');
    const startLy  = document.getElementById('startLayer');
    const btnStart = document.getElementById('btnStart');
    const btnUnmute= document.getElementById('btnUnmute');
    const menu     = document.getElementById('menu');

    function setSources(el, webm, mp4=""){
      el.crossOrigin = "anonymous";
      el.innerHTML = "";
      if (webm){ const s1=document.createElement('source'); s1.src=webm; s1.type='video/webm; codecs="vp8,opus"'; el.appendChild(s1); }
      if (mp4 ){ const s2=document.createElement('source'); s2.src=mp4 ; s2.type='video/mp4'; el.appendChild(s2); }
      el.load();
    }

    /********** AR **********/
    let THREE, ZapparThree, renderer, camera, scene, tracker, anchor, plane;
    let hasPlaced = false;          // –¥—ç–ª—Ö–∏–π –¥—ç—ç—Ä –±–∞–π—Ä–ª—É—É–ª—Å–∞–Ω —ç—Å—ç—Ö
    let texIntro, texEx, currentVideo;

    // –¥—ç–ª–≥—ç—Ü–∏–π–Ω –ø–∏–∫—Å–µ–ª ‚Üí NDC (-1..1)
    function toNDC(clientX, clientY){
      const x =  (clientX / innerWidth ) * 2 - 1;
      const y = -(clientY / innerHeight) * 2 + 1;
      return [x, y];
    }

    // —á–∞–Ω–∞—Ä—Ç–∞–π –≤–∏–¥–µ–æ —Ç–µ–∫—Å—Ç—É—Ä
    function makeVideoTexture(el){
      const t = new THREE.VideoTexture(el);
      t.colorSpace = THREE.SRGBColorSpace;
      t.minFilter = THREE.LinearFilter;
      t.magFilter = THREE.LinearFilter;
      t.generateMipmaps = false;
      return t;
    }

    // –≤–∏–¥–µ–æ–Ω—ã —Ö–∞—Ä—å—Ü–∞–∞–≥–∞–∞—Ä plane —Ö—ç–º–∂—ç—ç
    function fitPlaneToVideo(el){
      const w = el.videoWidth  || 1280;
      const h = el.videoHeight || 720;
      const H = 1.0; // 1–º ”©–Ω–¥”©—Ä
      const W = H * (w/h);
      plane.geometry.dispose();
      plane.geometry = new THREE.PlaneGeometry(W, H);
    }

    // permission + camera.resume
    async function ensureCamera() {
      const ok = await ZapparThree.permissionRequest();
      if (!ok) { ZapparThree.permissionDeniedUI(); throw new Error('Camera permission denied'); }
      camera?.start();
      dbg('camera started / resumed');
    }

    // –∂–µ—Å—Ç–∏–π–Ω —Ç”©–ª”©–≤ (–∑”©”©—Ö/—Ç–æ–º—Å–≥–æ—Ö/—ç—Ä–≥“Ø“Ø–ª—ç—Ö)
    const fingers = new Map();
    let dragging=false, baseScale=1, startPinchDist=0, startScale=1, startTwist=0, baseYaw=0;

    function dist(a,b){ return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY); }
    function ang(a,b){  return Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX); }

    (async function bootstrap(){
      ({ THREE, ZapparThree } = await window.__depsReady);
      if (!THREE || !ZapparThree) { alert('THREE/ZapparThree –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π'); throw new Error('Deps'); }
      if (ZapparThree.browserIncompatible()) { ZapparThree.browserIncompatibleUI(); return; }

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.domElement.classList.add('webgl');
      document.body.appendChild(renderer.domElement);
      addEventListener('resize', ()=>{
        renderer.setSize(innerWidth, innerHeight);
        renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
      });
      ZapparThree.glContextSet(renderer.getContext());

      // –ö–∞–º–µ—Ä + —Ç–∞–π–∑
      camera = new ZapparThree.Camera({ userFacing:false });
      scene  = new THREE.Scene();
      scene.background = camera.backgroundTexture;

      // –î—ç–ª—Ö–∏–π-–¥–∞—Ö—å —Ç—Ä–µ–∫–µ—Ä –±–∞ anchor
      tracker = new ZapparThree.InstantWorldTracker();
      anchor  = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
      scene.add(anchor);

      // –ö–æ–Ω—Ç–µ–Ω—Ç—ã–Ω plane (–≥–∞–∑–∞—Ä—Ç —Ö—ç–≤—Ç“Ø“Ø–ª–Ω—ç ‚Üí 360 —Ç–æ–π—Ä–æ–æ–¥ —Ö–∞—Ä–∂ –±–æ–ª–Ω–æ)
      plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1,1),
        new THREE.MeshBasicMaterial({ transparent:true, side:THREE.DoubleSide, toneMapped:false, alphaTest:0.01 })
      );
      plane.rotation.x = -Math.PI/2; // —à–∞–ª–∞–Ω –¥—ç—ç—Ä
      anchor.add(plane);

      // Render loop
      renderer.setAnimationLoop(()=>{
        if (!hasPlaced) {
          // –±–∞–π—Ä–ª—É—É–ª–∞—Ö–∞–∞—Å ”©–º–Ω”© –∫–∞–º–µ—Ä–∞–∞—Å -2–º —É—Ä–¥ "–¥–∞–≥—É—É–ª–∞–∞–¥" —è–≤–Ω–∞
          tracker.setAnchorPoseFromCameraOffset(0,0,-2);
        }
        camera.updateFrame(renderer);
        renderer.render(scene, camera);
      });

      // app bg/fg ‚Üí camera resume/pause
      document.addEventListener('visibilitychange', ()=>{
        if (!document.hidden) { try{ camera.start(); }catch{} } else { try{ camera.pause(); }catch{} }
      });

      dbg('bootstrap ready (press ‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–•)');
    })();

    // ‚îÄ‚îÄ “Æ–Ω–¥—Å—ç–Ω —É—Ä—Å–≥–∞–ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const vIntroEndedToMenu = ()=>{ menu.style.display='flex'; dbg('intro ended ‚Üí menu'); };

    btnStart.addEventListener('click', async ()=>{
      try{
        await ensureCamera();

        setSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
        setSources(vEx,    EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

        texIntro = texIntro || makeVideoTexture(vIntro);
        texEx    = texEx    || makeVideoTexture(vEx);

        currentVideo = vIntro;
        plane.material.map = texIntro;
        hasPlaced = false;

        if (vIntro.readyState>=1) fitPlaneToVideo(vIntro);
        else vIntro.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vIntro), { once:true });

        try { vIntro.muted=false; await vIntro.play(); btnUnmute.style.display='none'; }
        catch{ vIntro.muted=true; vIntro.play().catch(()=>{}); btnUnmute.style.display='inline-block'; }

        // –≠–•–ù–ò–ô –¢–ê–ü ‚Üí —è–≥ –¥–∞—Ä—Å–∞–Ω –≥–∞–∑–∞—Ä –ê–ù–• –ë–ê–ô–†–õ–£–£–õ–ù–ê
        const placeOnce = (e)=>{
          const p = e.changedTouches?.[0] || e;
          const [nx, ny] = toNDC(p.clientX, p.clientY);
          tracker.setAnchorPoseFromScreenCoordinates(nx, ny); // –¥—ç–ª—Ö–∏–π –¥—ç—ç—Ä —Ç–æ–≥—Ç–æ–æ–∂ –±–∞–π–Ω–∞
          hasPlaced = true;
          baseYaw = plane.rotation.y;
          removeEventListener('pointerdown', placeOnce);
          dbg('intro placed (world-locked)');
        };
        addEventListener('pointerdown', placeOnce, { once:true, passive:true });

        startLy.style.display='none';
        vIntro.onended = vIntroEndedToMenu;
        dbg('intro playing (tap to place). When ended ‚Üí menu');
      }catch(e){ console.error(e); dbg('camera permission failed'); }
    });

    btnUnmute.addEventListener('click', async ()=>{
      try{ await currentVideo.play(); currentVideo.muted=false; btnUnmute.style.display='none'; }catch{}
    });

    document.getElementById('btnExercise').addEventListener('click', async ()=>{
      menu.style.display='none';
      try{ await ensureCamera(); }catch{}

      if (currentVideo) currentVideo.pause();
      currentVideo = vEx;
      plane.material.map = texEx;
      hasPlaced = false;

      if (vEx.readyState>=1) fitPlaneToVideo(vEx);
      else vEx.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vEx), { once:true });

      // –≠–•–ù–ò–ô –¢–ê–ü ‚Üí –¥–∞—Å–≥–∞–ª—ã–≥ –±–∞–π—Ä–ª—É—É–ª–∞–∞–¥ —Ç–æ–≥–ª—É—É–ª–Ω–∞
      const placeOnce = (e)=>{
        const p = e.changedTouches?.[0] || e;
        const [nx, ny] = toNDC(p.clientX, p.clientY);
        tracker.setAnchorPoseFromScreenCoordinates(nx, ny);
        hasPlaced = true;
        baseYaw = plane.rotation.y;
        vEx.currentTime = 0; vEx.muted = false; vEx.play().catch(()=>{});
        removeEventListener('pointerdown', placeOnce);
        dbg('exercise placed & playing (world-locked)');
      };
      addEventListener('pointerdown', placeOnce, { once:true, passive:true });

      dbg('exercise ready (tap to place & play)');
    });

    // ‚îÄ‚îÄ –ñ–µ—Å—Ç“Ø“Ø–¥: –∑”©”©—Ö / pinch-scale / twist-yaw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    addEventListener('pointerdown', (e)=>{
      fingers.set(e.pointerId, { clientX:e.clientX, clientY:e.clientY });
      if (fingers.size===1 && hasPlaced) dragging = true;
      if (fingers.size===2){
        const [a,b] = [...fingers.values()];
        startPinchDist = dist(a,b);
        startScale = baseScale;
        startTwist = ang(a,b);
      }
    }, { passive:true });

    addEventListener('pointermove', (e)=>{
      if (!hasPlaced || !fingers.has(e.pointerId)) return;
      fingers.set(e.pointerId, { clientX:e.clientX, clientY:e.clientY });

      // 1 —Ö—É—Ä—É—É ‚Üí –∑”©”©—Ö (screen-coords)
      if (fingers.size===1 && dragging){
        const t = [...fingers.values()][0];
        const [nx, ny] = toNDC(t.clientX, t.clientY);
        tracker.setAnchorPoseFromScreenCoordinates(nx, ny);
      }

      // 2 —Ö—É—Ä—É—É ‚Üí —Ç–æ–º—Å–≥–æ—Ö/—ç—Ä–≥“Ø“Ø–ª—ç—Ö
      if (fingers.size===2){
        const [a,b] = [...fingers.values()];
        // scale
        const s = (dist(a,b) / Math.max(1, startPinchDist));
        baseScale = THREE.MathUtils.clamp(startScale * s, 0.3, 3.0);
        plane.scale.setScalar(baseScale);
        // yaw
        const delta = ang(a,b) - startTwist;
        plane.rotation.y = baseYaw + delta;
      }
    }, { passive:true });

    addEventListener('pointerup', (e)=>{
      fingers.delete(e.pointerId);
      if (fingers.size<1) dragging=false;
      if (fingers.size<2) baseYaw = plane.rotation.y;
    }, { passive:true });

    addEventListener('pointercancel', (e)=>{
      fingers.delete(e.pointerId);
      dragging=false;
    }, { passive:true });
  </script>
</body>
</html>
