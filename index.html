<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR â€” Auto AR Experience</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    #startLayer{position:fixed;inset:0;display:grid;place-items:center;z-index:var(--z-ui);background:#000}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25);transition:transform 0.2s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.95)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,0.8)}
    .menu-inner{display:flex;flex-direction:column;gap:16px;padding:20px;border-radius:20px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px)}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.7);
           padding:8px 12px;border-radius:8px;font:12px/1.4 monospace;white-space:pre-wrap;max-width:90vw;
           border:1px solid rgba(0,255,0,0.3)}
    
    #loadingScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:var(--z-ui);
                   background:#000;flex-direction:column;gap:20px}
    
    .loading-spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;
                     border-radius:50%;animation:spin 1s linear infinite}
    
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    
    #permissionError{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-ui);
                     background:#000;flex-direction:column;gap:20px;text-align:center;padding:20px}
  </style>

  <!-- THREE + Zappar -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    // Clear any existing service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    
    // Wait for dependencies to load
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: Initializing...</div>

  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="loading-spinner"></div>
    <h2 style="color:#fff;margin:0;">Starting AR Experience...</h2>
    <p style="color:#ccc;margin:0;">Please allow camera access when prompted</p>
  </div>

  <!-- Permission Error Screen -->
  <div id="permissionError">
    <h2 style="color:#fff;margin-bottom:20px;">Camera Access Required</h2>
    <p style="color:#ccc;margin-bottom:30px;">This AR experience needs camera access to work properly.</p>
    <button id="btnRetry" class="btn">Try Again</button>
  </div>
  
  <button id="btnUnmute" class="btn">ðŸ”Š Enable Audio</button>
  
  <div id="menu">
    <div class="menu-inner">
      <h2 style="color:#fff;margin:0 0 10px 0;text-align:center;">Select Experience</h2>
      <button class="btn" id="btnExercise">Start Exercise</button>
      <button class="btn" id="btnRestart">Restart Intro</button>
    </div>
  </div>

  <!-- Hidden video elements -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

  <script>
    /********** Configuration **********/
    const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL      = "";
    const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL   = "";

    // Fixed AR content position (2 meters in front, at eye level)
    const AR_POSITION = { x: 0, y: 0, z: -2 };

    // Debug logger
    const dbg = (message) => {
      console.log('DEBUG:', message);
      document.getElementById('debug').textContent = 'DEBUG: ' + message;
    };

    // DOM elements
    const vIntro = document.getElementById('vidIntro');
    const vExercise = document.getElementById('vidExercise');
    const loadingScreen = document.getElementById('loadingScreen');
    const permissionError = document.getElementById('permissionError');
    const btnRetry = document.getElementById('btnRetry');
    const btnUnmute = document.getElementById('btnUnmute');
    const menu = document.getElementById('menu');

    // Set video sources with proper codec support
    function setupVideoSources(videoElement, webmUrl, mp4Url = "") {
      videoElement.innerHTML = "";
      
      if (webmUrl) {
        const webmSource = document.createElement('source');
        webmSource.src = webmUrl;
        webmSource.type = 'video/webm; codecs="vp8,opus"';
        videoElement.appendChild(webmSource);
      }
      
      if (mp4Url) {
        const mp4Source = document.createElement('source');
        mp4Source.src = mp4Url;
        mp4Source.type = 'video/mp4';
        videoElement.appendChild(mp4Source);
      }
      
      videoElement.load();
    }

    /********** AR Engine **********/
    let THREE, ZapparThree, renderer, camera, scene, tracker, anchor, plane;
    let introTexture, exerciseTexture, currentVideo;
    let arInitialized = false;

    // Request camera permissions
    async function requestCameraAccess() {
      try {
        const permitted = await ZapparThree.permissionRequest();
        if (!permitted) {
          throw new Error('Camera permission denied by user');
        }
        camera?.start();
        dbg('Camera access granted and started');
        return true;
      } catch (error) {
        dbg('Camera permission failed: ' + error.message);
        throw error;
      }
    }

    // Create video texture
    function createVideoTexture(videoElement) {
      const texture = new THREE.VideoTexture(videoElement);
      texture.colorSpace = THREE.SRGBColorSpace;
      texture.flipY = false;
      return texture;
    }

    // Fit plane to video aspect ratio and position it at fixed location
    function adjustPlaneToVideo(videoElement) {
      const width = videoElement.videoWidth || 1280;
      const height = videoElement.videoHeight || 720;
      const displayHeight = 1.2; // 1.2 meters tall for better visibility
      const displayWidth = displayHeight * (width / height);
      
      // Update geometry
      plane.geometry.dispose();
      plane.geometry = new THREE.PlaneGeometry(displayWidth, displayHeight);
      
      // Position at fixed location in front of user
      plane.position.set(AR_POSITION.x, AR_POSITION.y, AR_POSITION.z);
      plane.rotation.set(0, 0, 0); // Keep it straight
      
      dbg(`Video: ${width}x${height}, AR plane: ${displayWidth.toFixed(2)}x${displayHeight}m at fixed position`);
    }

    // Initialize AR system
    async function initializeAR() {
      try {
        // Wait for dependencies
        ({ THREE, ZapparThree } = await window.__depsReady);
        
        if (!THREE || !ZapparThree) {
          throw new Error('Failed to load THREE.js or ZapparThree dependencies');
        }

        // Check browser compatibility
        if (ZapparThree.browserIncompatible()) {
          ZapparThree.browserIncompatibleUI();
          return;
        }

        // Setup WebGL renderer
        renderer = new THREE.WebGLRenderer({ 
          antialias: true, 
          alpha: false, 
          powerPreference: 'high-performance' 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.classList.add('webgl');
        document.body.appendChild(renderer.domElement);

        // Handle window resize
        window.addEventListener('resize', () => {
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize Zappar GL context
        ZapparThree.glContextSet(renderer.getContext());

        // Setup camera and scene
        camera = new ZapparThree.Camera({ userFacing: false }); // Use back camera
        scene = new THREE.Scene();
        scene.background = camera.backgroundTexture;

        // Setup instant world tracking
        tracker = new ZapparThree.InstantWorldTracker();
        anchor = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
        scene.add(anchor);

        // Create display plane
        plane = new THREE.Mesh(
          new THREE.PlaneGeometry(1, 1),
          new THREE.MeshBasicMaterial({ 
            transparent: true, 
            side: THREE.DoubleSide 
          })
        );
        anchor.add(plane);

        // Start render loop
        renderer.setAnimationLoop(() => {
          // Always set content at fixed position (no user placement required)
          tracker.setAnchorPoseFromCameraOffset(AR_POSITION.x, AR_POSITION.y, AR_POSITION.z);
          
          // Update and render
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        });

        // Handle app visibility changes
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            try { camera.start(); } catch (e) { console.warn('Failed to restart camera:', e); }
          } else {
            try { camera.pause(); } catch (e) { console.warn('Failed to pause camera:', e); }
          }
        });

        arInitialized = true;
        dbg('AR system initialized successfully');
        
      } catch (error) {
        console.error('AR initialization failed:', error);
        dbg('AR initialization failed: ' + error.message);
        throw error;
      }
    }

    // Play video with audio handling
    async function playVideoWithAudio(videoElement) {
      try {
        videoElement.muted = false;
        await videoElement.play();
        btnUnmute.style.display = 'none';
        dbg('Video playing with audio');
      } catch (error) {
        // Fallback to muted playback
        videoElement.muted = true;
        try {
          await videoElement.play();
          btnUnmute.style.display = 'inline-block';
          dbg('Video playing muted - click unmute button');
        } catch (playError) {
          dbg('Failed to play video: ' + playError.message);
        }
      }
    }

    // Show permission error screen
    function showPermissionError() {
      loadingScreen.style.display = 'none';
      permissionError.style.display = 'flex';
    }

    // Hide all screens
    function hideAllScreens() {
      loadingScreen.style.display = 'none';
      permissionError.style.display = 'none';
    }

    // Start AR experience automatically
    async function startARExperience() {
      try {
        dbg('Auto-starting AR experience...');
        
        // Request camera access first
        await requestCameraAccess();

        // Setup video sources
        setupVideoSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
        setupVideoSources(vExercise, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

        // Create textures
        introTexture = introTexture || createVideoTexture(vIntro);
        exerciseTexture = exerciseTexture || createVideoTexture(vExercise);

        // Start with intro video
        currentVideo = vIntro;
        plane.material.map = introTexture;

        // Setup video dimensions
        if (vIntro.readyState >= 1) {
          adjustPlaneToVideo(vIntro);
        } else {
          vIntro.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vIntro), { once: true });
        }

        // Hide loading screen and start playing
        hideAllScreens();
        
        // Play intro video automatically
        await playVideoWithAudio(vIntro);
        
        dbg('Intro video playing automatically in AR');

        // Handle intro video end
        vIntro.onended = () => {
          menu.style.display = 'flex';
          dbg('Intro completed - showing menu');
        };

      } catch (error) {
        console.error('Failed to start AR experience:', error);
        dbg('Failed to start: ' + error.message);
        showPermissionError();
      }
    }

    // Retry button handler
    btnRetry.addEventListener('click', async () => {
      permissionError.style.display = 'none';
      loadingScreen.style.display = 'flex';
      await startARExperience();
    });

    // Enable audio button
    btnUnmute.addEventListener('click', async () => {
      if (currentVideo) {
        try {
          currentVideo.muted = false;
          await currentVideo.play();
          btnUnmute.style.display = 'none';
          dbg('Audio enabled');
        } catch (error) {
          dbg('Failed to enable audio: ' + error.message);
        }
      }
    });

    // Exercise button
    document.getElementById('btnExercise').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Starting exercise...');

        // Stop current video
        if (currentVideo) {
          currentVideo.pause();
        }

        // Switch to exercise video
        currentVideo = vExercise;
        plane.material.map = exerciseTexture;

        // Setup exercise video dimensions
        if (vExercise.readyState >= 1) {
          adjustPlaneToVideo(vExercise);
        } else {
          vExercise.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vExercise), { once: true });
        }

        // Play exercise video automatically
        vExercise.currentTime = 0; // Restart from beginning
        await playVideoWithAudio(vExercise);
        
        dbg('Exercise playing automatically in AR');

      } catch (error) {
        console.error('Failed to start exercise:', error);
        dbg('Failed to start exercise: ' + error.message);
      }
    });

    // Restart intro button
    document.getElementById('btnRestart').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Restarting intro...');

        // Stop current video
        if (currentVideo) {
          currentVideo.pause();
        }

        // Switch back to intro
        currentVideo = vIntro;
        plane.material.map = introTexture;

        // Reset and play intro automatically
        vIntro.currentTime = 0;
        await playVideoWithAudio(vIntro);

        dbg('Intro restarted and playing automatically');

      } catch (error) {
        console.error('Failed to restart intro:', error);
        dbg('Failed to restart: ' + error.message);
      }
    });

    // Initialize everything when page loads
    window.addEventListener('load', async () => {
      try {
        // Initialize AR system first
        await initializeAR();
        
        // Then automatically start the experience
        await startARExperience();
        
      } catch (error) {
        console.error('Failed to initialize:', error);
        dbg('Initialization failed - check console for details');
        showPermissionError();
      }
    });
  </script>
</body>
</html>