<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR (Unity + Alpha Video)</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}

    /* Арын камер */
    #cam{
      position:fixed; inset:0; width:100%; height:100%;
      object-fit:cover; z-index:0; background:#000;
      /* Хэрэв урд камер сонгогдвол тольдохоос сэргийлнэ */
      transform:scaleX(-1);
    }

    /* Unity canvas (тунгалаг) */
    #unity-canvas{
      position:fixed; inset:0; width:100vw; height:100vh;
      display:block; z-index:1; background:transparent !important;
    }

    /* Видеог барих gesture wrapper */
    #overlay-wrap{
      position:fixed; inset:0; z-index:2;
      display:none;           /* видео гарах үед block болно */
      touch-action:none;      /* pointer/gesture авахын тулд */
      background:transparent;
    }

    /* Alpha видеонууд */
    .overlay{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; pointer-events:none; display:none;
      background:transparent;
      transform-origin:center center; /* масштаб төвөөс */
    }

    /* UI */
    #ui{position:fixed; inset:0; display:grid; place-items:center; z-index:3; pointer-events:none}
    .btn{pointer-events:auto; padding:14px 22px; border:0; border-radius:12px; font-size:16px; background:#fff; color:#111; cursor:pointer}
    #exerciseBtn{position:fixed; bottom:24px; left:50%; transform:translateX(-50%); display:none}

    /* Loading / Autoplay fallback */
    #loading{position:fixed; inset:0; display:grid; place-items:center; z-index:1; color:#fff}
    #tap{position:fixed; inset:0; display:none; place-items:center; z-index:4; background:rgba(0,0,0,.6); color:#fff; font:600 16px system-ui}
    #tap>div{background:#111; padding:12px 16px; border-radius:10px}
  </style>
</head>
<body>
  <!-- Арын камер -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- Unity -->
  <canvas id="unity-canvas" tabindex="-1"></canvas>
  <div id="loading">Түр хүлээнэ үү…</div>

  <!-- Alpha видеонууд (gesture wrapper-тай) -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline muted></video>
    <video id="exercise" class="overlay" playsinline muted></video>
  </div>

  <!-- UI -->
  <div id="ui"><button id="exerciseBtn" class="btn">Дасгал</button></div>

  <!-- Autoplay fallback -->
  <div id="tap"><div>Тоглуулахын тулд товш</div></div>

  <!-- ===== Unity loader (таны build нэрэнд тааруулсан) ===== -->
  <script>
    const buildUrl = "Build";
    const loaderUrl = buildUrl + "/build.loader.js";
    const config = {
      dataUrl:      buildUrl + "/build.data.unityweb",
      frameworkUrl: buildUrl + "/build.framework.js.unityweb",
      codeUrl:      buildUrl + "/build.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "No",
      productVersion: "0.1",
      // Canvas-ийг тунгалаг болгох чухал тохиргоо
      webglContextAttributes: { alpha: true, premultipliedAlpha: false }
    };

    const canvas   = document.getElementById("unity-canvas");
    const loading  = document.getElementById("loading");
    const script   = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config).then(u => {
        loading.remove();
        window.unityInstance = u;
      }).catch(e => {
        loading.textContent = "Unity ачаалахад алдаа: " + e;
        console.error(e);
      });
    };
    document.body.appendChild(script);
  </script>

  <!-- ===== WebAR логик (камера + alpha видео + gesture) ===== -->
  <script>
    // === ТАНЫ ВИДЕО URL-ууд (зайлшгүй HTTPS) ===
    const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

    // iOS HEVC-with-alpha fallback байвал хоёр дахь source болгон нэмээрэй:
    // const INTRO_IOS    = "https://.../output_alpha_hevc.mp4";
    // const EXERCISE_IOS = "https://.../dasgal_hevc.mp4";

    const cam         = document.getElementById('cam');
    const wrap        = document.getElementById('overlay-wrap');
    const intro       = document.getElementById('intro');
    const exercise    = document.getElementById('exercise');
    const exerciseBtn = document.getElementById('exerciseBtn');
    const tap         = document.getElementById('tap');

    // Intro-г 1 удаа л үзүүлэх
    const INTRO_SEEN_KEY = "introSeen_v1";
    const hasSeenIntro   = () => localStorage.getItem(INTRO_SEEN_KEY) === "1";
    const markIntroSeen  = () => localStorage.setItem(INTRO_SEEN_KEY, "1");

    // Камер (арын) асгах
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } }, audio: false
        });
        cam.srcObject = stream;
        await cam.play();
      } catch (err) {
        alert("Камерын зөвшөөрөл хэрэгтэй байна: " + err.message);
        console.error(err);
      }
    }

    // Видеоны эх сурвалж оноох
    function setVideoSources(el, url /*, iosUrl*/) {
      el.innerHTML = "";
      const sWebm = document.createElement('source');
      sWebm.src  = url;
      sWebm.type = 'video/webm; codecs="vp8,opus"';
      el.appendChild(sWebm);
      // iOS fallback (HEVC alpha) байвал идэвхжүүл
      // if (iosUrl) {
      //   const sHevc = document.createElement('source');
      //   sHevc.src  = iosUrl;
      //   sHevc.type = 'video/mp4; codecs="hvc1"';
      //   el.appendChild(sHevc);
      // }
    }

    // Autoplay саатвал богино fallback
    async function safePlay(videoEl) {
      try {
        await videoEl.play();
        tap.style.display = "none";
      } catch (e) {
        console.warn("Autoplay blocked, need gesture:", e);
        tap.style.display = "grid";
        const once = () => {
          tap.style.display = "none";
          videoEl.play().catch(err => console.error("Still blocked:", err));
          tap.removeEventListener('click', once);
        };
        tap.addEventListener('click', once);
      }
    }

    // ---- Gesture (drag + pinch-zoom) ----
    let active = null;               // одоогийн идэвхтэй видео
    let startDist = 0, startScale = 1, scale = 1;
    let startX = 0, startY = 0, tx = 0, ty = 0;

    function setTransform() {
      if (!active) return;
      active.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    }

    function getDist(t0, t1) {
      const dx = t0.clientX - t1.clientX;
      const dy = t0.clientY - t1.clientY;
      return Math.hypot(dx, dy);
    }

    // Drag (pointer)
    wrap.addEventListener('pointerdown', e => {
      wrap.setPointerCapture(e.pointerId);
      startX = e.clientX - tx;
      startY = e.clientY - ty;
    });
    wrap.addEventListener('pointermove', e => {
      if (!active) return;
      tx = e.clientX - startX;
      ty = e.clientY - startY;
      setTransform();
    });

    // Pinch-zoom (touch)
    let touches = [];
    wrap.addEventListener('touchstart', (e) => {
      touches = e.touches;
      if (touches.length === 1) {
        startX = touches[0].clientX - tx;
        startY = touches[0].clientY - ty;
      } else if (touches.length === 2) {
        startDist  = getDist(touches[0], touches[1]);
        startScale = scale;
      }
    }, {passive:false});

    wrap.addEventListener('touchmove', (e) => {
      e.preventDefault();
      touches = e.touches;
      if (!active) return;
      if (touches.length === 1) {
        tx = touches[0].clientX - startX;
        ty = touches[0].clientY - startY;
        setTransform();
      } else if (touches.length === 2) {
        const d = getDist(touches[0], touches[1]);
        scale = Math.max(0.2, Math.min(5, startScale * (d / startDist)));
        setTransform();
      }
    }, {passive:false});

    // Давхар товшвол reset
    let lastTap = 0;
    wrap.addEventListener('click', () => {
      const now = Date.now();
      if (now - lastTap < 300) {
        scale = 1; tx = 0; ty = 0; setTransform();
      }
      lastTap = now;
    });

    // Туслах функцууд
    function showIntro() {
      active = intro;
      wrap.style.display = "block";
      intro.style.display = "block";
    }
    function hideIntro() {
      intro.style.display = "none";
      if (active === intro) active = null;
    }
    function showExercise() {
      active = exercise;
      wrap.style.display = "block";
      exercise.style.display = "block";
    }

    // Урсгал: хуудсыг нээнгүүт permission → intro (эсвэл шууд товч)
    async function boot() {
      await startCamera();

      setVideoSources(intro,    INTRO_URL /*, INTRO_IOS*/);
      setVideoSources(exercise, EXERCISE_URL /*, EXERCISE_IOS*/);

      intro.loop    = false; // 1 л удаа
      exercise.loop = true;  // дасгал loop

      if (!hasSeenIntro()) {
        // Эхлэхэд байрлалыг цэвэрлэе
        scale = 1; tx = 0; ty = 0; setTransform();
        showIntro();
        intro.currentTime = 0;
        await safePlay(intro);
      } else {
        exerciseBtn.style.display = "inline-block";
      }
    }

    // Intro дуусмагц → товч гарна, дахиж intro үзэгдэхгүй
    intro.addEventListener('ended', () => {
      hideIntro();
      markIntroSeen();
      exerciseBtn.style.display = "inline-block";
    });

    // “Дасгал” товч → дасгалын видео loop-той
    exerciseBtn.addEventListener('click', async () => {
      // эхлэх бүрт байрлалыг default болгоё
      scale = 1; tx = 0; ty = 0; setTransform();
      showExercise();
      exercise.currentTime = 0;
      await safePlay(exercise);
    });

    // iOS zoom gesture саатлаас сэргийлэх
    document.addEventListener('gesturestart', e => e.preventDefault());

    // Шууд эхлүүлэх
    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
