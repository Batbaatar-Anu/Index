<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro‚Üí–ú–µ–Ω—é‚Üí–î–∞—Å–≥–∞–ª (Audio, Drag & Zoom + Intro Hotspots)</title>
  <style>
    :root { --z-cam:0; --z-canvas:1; --z-video:2; --z-menu:3; --z-hot:4; --z-toast:5; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    /* –ö–∞–º–µ—Ä (–∞—Ä—ã–Ω) */
    #cam{
      position:fixed;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;z-index:var(--z-cam);
      transform:scaleX(-1);
    }

    /* Unity canvas (—Ö—ç—Ä—ç–≥–ª—ç—Ö–≥“Ø–π —á “Ø–ª–¥—ç—ç–µ) */
    #unity-canvas{
      position:fixed;inset:0;width:100vw;height:100vh;
      background:transparent!important;z-index:var(--z-canvas);display:none;
    }

    /* –í–∏–¥–µ–æ–Ω—É—É–¥ */
    #overlay-wrap{ position:fixed; inset:0; z-index:var(--z-video); display:none; touch-action:none; }
    .overlay{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; background:transparent; display:none;
      pointer-events:auto; transform-origin:center center;
      transform:translate(0,0) scale(1);
    }

    /* –ú–µ–Ω—é */
    #menu{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:var(--z-menu); pointer-events:none; background:none; animation:fadeIn .35s ease both;
    }
    .menu-inner{
      display:flex; flex-direction:column; gap:12px; pointer-events:auto;
      transform:translateY(18px); opacity:0; animation:slideUp .4s .05s ease-out both;
    }
    .btn{
      width:200px; text-align:center; padding:14px 18px; border:0; border-radius:14px; cursor:pointer;
      background:#fff; color:#111; font-weight:700; font-size:16px; box-shadow:0 8px 28px rgba(0,0,0,.25);
    }
    .btn:active{ transform:translateY(1px) }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(18px)}}

    /* Intro-–¥ –ó”®–í–•”®–ù —Ö–∞—Ä–∞–≥–¥–∞—Ö hotspots (–¥–∞—Ä–∂ –±–æ–ª–æ—Ö–≥“Ø–π) */
    #hotspots{ position:fixed; inset:0; z-index:var(--z-hot); display:none; pointer-events:none; }
    .hotbtn{
      position:absolute; transform:translate(-50%,-50%);
      padding:10px 14px; border:0; border-radius:12px;
      background:rgba(17,17,17,.9); color:#fff; font-weight:700; font-size:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.28); opacity:0; animation:hotIn .25s ease forwards;
      user-select:none;
    }
    @keyframes hotIn{from{opacity:0;transform:translate(-50%,-58%)}to{opacity:1;transform:translate(-50%,-50%)}}

    /* Autoplay —Å–∞–Ω—É—É–ª–≥–∞ */
    #toast{
      position:fixed; left:50%; top:18px; transform:translateX(-50%); z-index:var(--z-toast);
      background:rgba(0,0,0,.7); color:#fff; border-radius:10px; padding:10px 14px; font-size:13px; display:none;
    }

    /* Reset (—Å–æ–Ω–≥–æ–ª—Ç–æ–æ—Ä) */
    #reset{
      position:fixed; right:12px; bottom:20px; z-index:var(--z-menu);
      padding:10px 12px; border:0; border-radius:10px; background:#fff; color:#111; cursor:pointer; display:none;
    }
  </style>
</head>
<body>
  <!-- –ö–∞–º–µ—Ä -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- Unity canvas (—à–∞–∞—Ä–¥–≤–∞–ª) -->
  <canvas id="unity-canvas"></canvas>

  <!-- –í–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- Intro “Ø–µ–∏–π–Ω —Ü–∞–≥—Ç–∞–π hotspots (display-only) -->
  <div id="hotspots"></div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  /* ===== –¢–ê–ù–´ URL-—É—É–¥ ===== */
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

  /* ===== –≠–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥ ===== */
  const cam = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro = document.getElementById('intro');
  const exercise = document.getElementById('exercise');
  const menu = document.getElementById('menu');
  const btnExercise = document.getElementById('btnExercise');
  const toast = document.getElementById('toast');
  const resetBtn = document.getElementById('reset');
  const hotspotLayer = document.getElementById('hotspots');

  /* ===== –ê—É–¥–∏–æ resume ===== */
  let audioCtx;
  async function ensureAudioFromStart(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return;
      if (!audioCtx) audioCtx = new Ctx();
      if (audioCtx.state === 'suspended') { await audioCtx.resume().catch(()=>{}); }
    }catch(_){}
  }

  /* ===== –ö–∞–º–µ—Ä ===== */
  async function startCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      cam.srcObject = stream; await cam.play();
    }catch(e){
      console.warn('No camera, continue without AR bg:', e.message);
      cam.style.display = 'none'; // –∫–∞–º–µ—Ä–∞–∞—Ä –±“Ø—Ç—ç—Ö–≥“Ø–π –±–æ–ª –∑“Ø–≥—ç—ç—Ä –Ω—É—É—á–∏—Ö
    }
  }

  /* ===== –≠—Ö —Å—É—Ä–≤–∞–ª–∂ –æ–Ω–æ–æ—Ö ===== */
  function setSources(videoEl, webmUrl){
    videoEl.innerHTML = "";
    const s1 = document.createElement('source');
    s1.src = webmUrl;
    s1.type = 'video/webm; codecs="vp8,opus"';
    videoEl.appendChild(s1);
  }

  /* ===== Drag + Pinch-Zoom (–ª–æ–≥–∏–∫ ”©”©—Ä—á–ª”©–≥–¥”©”©–≥“Ø–π) ===== */
  let active = null, scale = 1, startScale = 1, tx = 0, ty = 0, startX = 0, startY = 0, startDist = 0;
  const dist = (a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);

  function applyTransform(){ if(!active) return; active.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`; }
  function resetTransform(){ scale = 1; tx = 0; ty = 0; applyTransform(); }

  wrap.addEventListener('mousedown', e=>{
    startX = e.clientX - tx; startY = e.clientY - ty;
    const mm = e2 => { tx = e2.clientX - startX; ty = e2.clientY - startY; applyTransform(); };
    const mu = ()=>{ window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
  });

  wrap.addEventListener('touchstart', e=>{
    if(!active) return;
    if(e.touches.length===1){ startX = e.touches[0].clientX - tx; startY = e.touches[0].clientY - ty; }
    else if(e.touches.length===2){ startDist = dist(e.touches[0], e.touches[1]); startScale = scale; }
  }, {passive:false});

  wrap.addEventListener('touchmove', e=>{
    if(!active) return; e.preventDefault();
    if(e.touches.length===1){ tx = e.touches[0].clientX - startX; ty = e.touches[0].clientY - startY; }
    else if(e.touches.length===2){ const d = dist(e.touches[0], e.touches[1]); scale = Math.max(0.5, Math.min(3, startScale*(d/startDist))); }
    applyTransform();
  }, {passive:false});

  // double-tap/click ‚Üí reset
  let lastTap = 0;
  wrap.addEventListener('click', ()=>{ const now = Date.now(); if(now - lastTap < 300) resetTransform(); lastTap = now; });
  resetBtn.addEventListener('click', resetTransform);

  /* ===== Autoplay fallback ===== */
  async function playWithAudio(el){
    el.muted = false; el.volume = 1.0;
    try{ await el.play(); toast.style.display='none'; }
    catch{
      toast.textContent = "üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É";
      toast.style.display = "block";
      el.muted = true; el.play().catch(()=>{});
      const enable = ()=>{ el.muted=false; el.volume=1.0; toast.style.display='none'; document.removeEventListener('pointerdown', enable, {passive:true}); };
      document.addEventListener('pointerdown', enable, {passive:true, once:true});
    }
  }

  /* ===== Intro-–¥ –ó”®–í–•”®–ù —Ö–∞—Ä–∞–≥–¥–∞—Ö hotspot-—É—É–¥ =====
     x,y ‚Äî % –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç; start/end ‚Äî —Å–µ–∫—É–Ω–¥
     -> –≠–Ω–¥ —Å–µ–∫—É–Ω–¥, –±–∞–π—Ä–ª–∞–ª–∞–∞ –±–∏—á–ª—ç–≥—Ç—ç—ç —Ç–∞–∞—Ä—É—É–ª–∞–∞–¥ ”©”©—Ä—á–∏–ª–Ω”©.
  */
  const INTRO_HOTSPOTS = [
    { start: 2.0, end: 4.5, items: [
      { id:'hs1', label:'–ó–∞–∞–≤–∞—Ä',   x:28, y:56 },
      { id:'hs2', label:'–ú—ç–¥—ç—ç–ª—ç–ª', x:64, y:42 }
    ]},
    { start: 7.0, end: 9.5, items: [
      { id:'hs3', label:'–î–∞—Ä–∞–∞—Ö –∞–ª—Ö–∞–º', x:50, y:78 }
    ]}
  ];

  let hotspotSpec = [], lastWindow = null;
  function clearHotspots(){ hotspotLayer.innerHTML=""; hotspotLayer.style.display="none"; lastWindow=null; }
  function renderHotspots(items){
    hotspotLayer.innerHTML = ""; hotspotLayer.style.display = "block";
    for(const it of items){
      const b = document.createElement('div');
      b.className = 'hotbtn';
      b.textContent = it.label;
      b.style.left = it.x + '%';
      b.style.top  = it.y + '%';
      // pointer-events:none —Ç—É–ª –∏–Ω—Ç—Ä–æ–¥ –¥–∞—Ä–∂ –±–æ–ª–æ—Ö–≥“Ø–π ‚Äî –∑”©–≤—Ö”©–Ω —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
      hotspotLayer.appendChild(b);
    }
  }
  function updateHotspots(t){
    const win = hotspotSpec.find(w => t>=w.start && t<=w.end) || null;
    if(!win){ if(lastWindow) clearHotspots(); return; }
    if(lastWindow && win.start===lastWindow.start && win.end===lastWindow.end) return;
    lastWindow = win; renderHotspots(win.items);
  }
  function onIntroTime(){ updateHotspots(intro.currentTime); }

  /* ===== –£—Ä—Å–≥–∞–ª ===== */
  async function boot(){
    await startCamera();
    await ensureAudioFromStart();

    setSources(intro, INTRO_URL);
    setSources(exercise, EXERCISE_URL);

    wrap.style.display = "block";
    resetBtn.style.display = "inline-block";

    // Intro —ç—Ö–ª“Ø“Ø–ª—ç—Ö
    active = intro; resetTransform();
    intro.currentTime = 0;
    intro.style.display = "block";

    // Intro –¥—ç—ç—Ä hotspot —Ç–∞–π–º–∏–Ω–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª–Ω—ç
    hotspotSpec = INTRO_HOTSPOTS;
    intro.addEventListener('timeupdate', onIntroTime);

    await playWithAudio(intro);
  }

  // Intro –¥—É—É—Å–º–∞–≥—Ü ‚Üí hotspots –∞–ª–≥–∞ –±–æ–ª–∂, –º–µ–Ω—é –≥–∞—Ä–Ω–∞ (—Ç–∞–Ω—ã ”©–º–Ω”©—Ö –ª–æ–≥–∏–∫)
  intro.addEventListener('ended', ()=>{
    clearHotspots();
    intro.removeEventListener('timeupdate', onIntroTime);
    intro.style.display = "none";
    active = null;
    menu.style.display = "flex";
  });

  // ‚Äú–î–∞—Å–≥–∞–ª‚Äù —Ç–æ–≤—á ‚Üí exercise alpha-–≥ –∫–∞–º–µ—Ä—ã–Ω –¥—ç—ç—Ä loop-—Ç–æ–π
  btnExercise.addEventListener('click', async ()=>{
    menu.style.display = "none";
    active = exercise; resetTransform();
    exercise.currentTime = 0; exercise.style.display = "block";
    try{ await exercise.play(); toast.style.display='none'; }
    catch{
      toast.style.display='block';
      exercise.muted = true; exercise.play().catch(()=>{});
      const enable2 = ()=>{ exercise.muted=false; exercise.volume=1.0; toast.style.display='none'; document.removeEventListener('pointerdown', enable2, {passive:true}); };
      document.addEventListener('pointerdown', enable2, {passive:true, once:true});
    }
  });

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
