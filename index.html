<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro‚Üí–ú–µ–Ω—é‚Üí–î–∞—Å–≥–∞–ª (Audio, Drag & Zoom)</title>
  <style>
    :root { --z-cam:0; --z-canvas:1; --z-video:2; --z-menu:3; --z-toast:4; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}
    #cam{
      position:fixed;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;z-index:var(--z-cam);
      transform:scaleX(-1);
    }
    #unity-canvas{
      position:fixed;inset:0;width:100vw;height:100vh;
      background:transparent!important;z-index:var(--z-canvas);display:none;
    }
    #overlay-wrap{
      position:fixed;inset:0;z-index:var(--z-video);
      display:none; touch-action:none;
    }
    .overlay{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:contain;background:transparent;display:none;pointer-events:auto;
      transform-origin:center center; transform:translate(0px,0px) scale(1);
    }
    #menu{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);
      pointer-events:none;background:none;animation:fadeIn .35s ease both;
    }
    .menu-inner{display:flex;flex-direction:column;gap:12px;pointer-events:auto;transform:translateY(18px);opacity:0;animation:slideUp .4s .05s ease-out both}
    .btn{width:200px;text-align:center;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;font-size:16px;box-shadow:0 8px 28px rgba(0,0,0,.25);transform:translateY(0);transition:transform .15s ease}
    .btn:active{transform:translateY(1px)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(18px)}}
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
    #reset{position:fixed;right:12px;bottom:20px;z-index:var(--z-menu);padding:10px 12px;border:0;border-radius:10px;background:#fff;color:#111;cursor:pointer;display:none}
  </style>
</head>
<body>
  <video id="cam" playsinline autoplay muted></video>
  <canvas id="unity-canvas"></canvas>

  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

  const cam = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro = document.getElementById('intro');
  const exercise = document.getElementById('exercise');
  const toast = document.getElementById('toast');
  const resetBtn = document.getElementById('reset');

  let audioCtx;
  async function ensureAudioFromStart(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return;
      if(!audioCtx) audioCtx = new Ctx();
      if(audioCtx.state === 'suspended'){ await audioCtx.resume().catch(()=>{}); }
    }catch(e){}
  }

  async function startCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }, audio:false
    });
    cam.srcObject = stream;
    await cam.play();
  }

  async function stopCam(){
    try{
      if(cam.srcObject){ cam.srcObject.getTracks().forEach(t=>t.stop()); }
      cam.srcObject = null;
      cam.style.display = 'none';
    }catch(e){}
  }

  function setSources(videoEl, webmUrl){
    videoEl.innerHTML = "";
    const s1 = document.createElement('source');
    s1.src = webmUrl;
    s1.type = 'video/webm; codecs="vp8,opus"';
    videoEl.appendChild(s1);
  }

  let active = null;
  let scale = 1, startScale = 1;
  let tx = 0, ty = 0, startX = 0, startY = 0;
  let startDist = 0;
  const dist = (t0, t1) => {
    const dx = t0.clientX - t1.clientX, dy = t0.clientY - t1.clientY;
    return Math.hypot(dx,dy);
  };
  function applyTransform(){
    if (!active) return;
    active.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
  }
  function resetTransform(){ scale = 1; tx = 0; ty = 0; applyTransform(); }

  function bindGesture(el){
    el.addEventListener('mousedown', e=>{
      startX = e.clientX - tx; startY = e.clientY - ty;
      const mm = e2 => { tx = e2.clientX - startX; ty = e2.clientY - startY; applyTransform(); };
      const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
      window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
    });
    el.addEventListener('touchstart', e=>{
      if (!active) return;
      if (e.touches.length === 1){
        startX = e.touches[0].clientX - tx; startY = e.touches[0].clientY - ty;
      } else if (e.touches.length === 2){
        startDist = dist(e.touches[0], e.touches[1]); startScale = scale;
      }
    }, {passive:false});
    el.addEventListener('touchmove', e=>{
      if (!active) return;
      e.preventDefault();
      if (e.touches.length === 1){
        tx = e.touches[0].clientX - startX; ty = e.touches[0].clientY - startY;
      } else if (e.touches.length === 2){
        const d = dist(e.touches[0], e.touches[1]);
        scale = Math.max(0.5, Math.min(3, startScale * (d / startDist)));
      }
      applyTransform();
    }, {passive:false});
  }

  wrap.addEventListener('mousedown', e=>{
    startX = e.clientX - tx; startY = e.clientY - ty;
    const mm = e2 => { tx = e2.clientX - startX; ty = e2.clientY - startY; applyTransform(); };
    const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
  });
  wrap.addEventListener('touchstart', e=>{
    if (!active) return;
    if (e.touches.length === 1){
      startX = e.touches[0].clientX - tx; startY = e.touches[0].clientY - ty;
    } else if (e.touches.length === 2){
      startDist = dist(e.touches[0], e.touches[1]); startScale = scale;
    }
  }, {passive:false});
  wrap.addEventListener('touchmove', e=>{
    if (!active) return;
    e.preventDefault();
    if (e.touches.length === 1){
      tx = e.touches[0].clientX - startX; ty = e.touches[0].clientY - startY;
    } else if (e.touches.length === 2){
      const d = dist(e.touches[0], e.touches[1]);
      scale = Math.max(0.5, Math.min(3, startScale * (d / startDist)));
    }
    applyTransform();
  }, {passive:false});

  let lastTap = 0;
  wrap.addEventListener('click', ()=>{
    const now = Date.now();
    if (now - lastTap < 300) resetTransform();
    lastTap = now;
  });
  resetBtn.addEventListener('click', resetTransform);

  async function boot(){
    try{
      await startCamera();
      await ensureAudioFromStart();
    }catch(err){
      alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: " + err.message);
      return;
    }
    setSources(intro, INTRO_URL);
    setSources(exercise, EXERCISE_URL);
    bindGesture(intro);
    bindGesture(exercise);
    wrap.style.display = "block";
    resetBtn.style.display = "inline-block";
    active = intro; resetTransform();
    intro.currentTime = 0;
    intro.style.display = "block";
    intro.muted = false; intro.volume = 1.0;
    try{
      await intro.play(); toast.style.display = "none";
    }catch(e){
      toast.textContent = "üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É";
      toast.style.display = "block";
      intro.muted = true; intro.play().catch(()=>{});
      const enableAudio = ()=>{
        intro.muted = false; intro.volume = 1.0; toast.style.display = "none";
        document.removeEventListener('pointerdown', enableAudio, {passive:true});
      };
      document.addEventListener('pointerdown', enableAudio, {passive:true, once:true});
    }
  }

  intro.addEventListener('ended', ()=>{
    intro.style.display = "none";
    document.getElementById('menu').style.display = "flex";
  });
</script>

<!-- ===== three.js + WebXR AR —Ö—ç—Å—ç–≥ ===== -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

  const menuEl = document.getElementById('menu');
  const overlayWrapEl = document.getElementById('overlay-wrap');

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);
  Object.assign(renderer.domElement.style, {
    position:'fixed', inset:'0', width:'100vw', height:'100vh',
    zIndex:'1', background:'transparent'
  });

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1));

  let xrRefSpace, viewerSpace, hitTestSource, placed = false, videoMesh;

  const sessionInit = {
    requiredFeatures: ['hit-test'],
    optionalFeatures: ['dom-overlay'],
    domOverlay: { root: document.body }
  };

  async function startAR() {
    if (!navigator.xr) { alert('WebXR –¥—ç–º–∂–¥—ç–≥–≥“Ø–π –±—Ä–∞—É–∑–µ—Ä (Chrome Android –∞—à–∏–≥–ª–∞–∞—Ä–∞–π).'); return; }

    const session = await navigator.xr.requestSession('immersive-ar', sessionInit);

    session.addEventListener('end', () => {
      placed = false;
      if (videoMesh) videoMesh.visible = false;
      // menuEl.style.display = 'flex'; // —Ö“Ø—Å–≤—ç–ª AR –¥—É—É—Å–º–∞–≥—Ü –±—É—Ü–∞–∞–∂ –º–µ–Ω—é –≥–∞—Ä–≥–∞
    });

    renderer.xr.setReferenceSpaceType('local');
    await renderer.xr.setSession(session);

    xrRefSpace = await session.requestReferenceSpace('local');
    viewerSpace = await session.requestReferenceSpace('viewer');
    hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

    onWindowResize();
    window.addEventListener('resize', onWindowResize);
    renderer.setAnimationLoop(onXRFrame);
  }

  function onWindowResize(){ renderer.setSize(window.innerWidth, window.innerHeight); }

  // HTML-–∏–π–Ω exercise –≤–∏–¥–µ–æ–≥ texture –±–æ–ª–≥–æ–Ω–æ
  const exerciseEl = document.getElementById('exercise');
  const videoTex = new THREE.VideoTexture(exerciseEl);
  videoTex.encoding = THREE.sRGBEncoding;

  const planeGeo = new THREE.PlaneGeometry(1.2, 0.68); // 1.2–º x 0.68–º –∂–∏—à—ç—ç
  const planeMat = new THREE.MeshBasicMaterial({ map: videoTex, transparent: true, side: THREE.DoubleSide });
  videoMesh = new THREE.Mesh(planeGeo, planeMat);
  videoMesh.visible = false;
  scene.add(videoMesh);

  function onXRFrame(t, frame) {
    const pose = frame.getViewerPose(xrRefSpace);
    if (!pose) return;

    if (!placed) {
      const hits = frame.getHitTestResults(hitTestSource);
      if (hits.length > 0) {
        const hitPose = hits[0].getPose(xrRefSpace);

        videoMesh.visible = true;
        videoMesh.position.set(
          hitPose.transform.position.x,
          hitPose.transform.position.y,
          hitPose.transform.position.z
        );

        const m = new THREE.Matrix4().fromArray(hitPose.transform.matrix);
        videoMesh.setRotationFromMatrix(m);
        videoMesh.rotateX(-Math.PI / 2); // –≥–∞–∑–∞—Ä—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å –±–æ–ª–≥–æ–Ω–æ

        placed = true;

        // Autoplay: await –∞—à–∏–≥–ª–∞—Ö–≥“Ø–π, Promise.catch() fallback
        exerciseEl.muted = false;
        exerciseEl.currentTime = 0;
        exerciseEl.play().catch(() => {
          exerciseEl.muted = true;
          exerciseEl.play().catch(()=>{});
          const enableAudio = ()=>{
            exerciseEl.muted = false;
            document.removeEventListener('pointerdown', enableAudio, {passive:true});
          };
          document.addEventListener('pointerdown', enableAudio, {passive:true, once:true});
        });
      }
    }

    renderer.render(scene, camera);
  }

  // "–î–∞—Å–≥–∞–ª" –¥–∞—Ä–º–∞–≥—Ü AR —ç—Ö–ª“Ø“Ø–ª–Ω—ç
  document.getElementById('btnExercise').addEventListener('click', async () => {
    menuEl.style.display = 'none';
    overlayWrapEl.style.display = 'none';
    await window.stopCam();   // getUserMedia-–≥–∞–∞ —É–Ω—Ç—Ä–∞–∞–∂ WebXR-–¥ –∫–∞–º–µ—Ä —Å—É–ª–ª–∞–Ω–∞
    await startAR();
  });

  // –≠—Ö–Ω–∏–π –∞—á–∞–∞–ª–∞–ª—Ç (–∏–Ω—Ç—Ä–æ, –º–µ–Ω—é)
  window.addEventListener('DOMContentLoaded', window.boot);
</script>
</body>
</html>
