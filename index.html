<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro‚Üí–ú–µ–Ω—é‚Üí–î–∞—Å–≥–∞–ª (Audio, Drag & Zoom + Hotspots)</title>
  <style>
    :root { --z-cam:0; --z-video:2; --z-menu:3; --z-hot:4; --z-toast:5 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    /* –ö–∞–º–µ—Ä */
    #cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:var(--z-cam);transform:scaleX(-1)}

    /* –í–∏–¥–µ–æ–Ω—É—É–¥ */
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);display:none;touch-action:none}
    .overlay{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:contain;background:transparent;display:none;
      pointer-events:auto;                   /* gesture-–∏–π–≥ –≤–∏–¥–µ–æ ”©”©—Ä –¥—ç—ç—Ä –∞–≤–Ω–∞ */
      transform-origin:center center;transform:translate(0,0) scale(1)
    }

    /* –¢”©–≤ –º–µ–Ω—é */
    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);pointer-events:none}
    .menu-inner{display:flex;flex-direction:column;gap:12px;pointer-events:auto;transform:translateY(18px);opacity:0;animation:slideUp .4s ease-out forwards}
    .btn{width:200px;text-align:center;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;font-size:16px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    .btn:active{transform:translateY(1px)}
    @keyframes slideUp{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(18px)}}

    /* Hotspots ‚Äì –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–∞—Ä –±–∞–π—Ä–ª–∞—Ö —Ç–æ–≤—á–Ω—É—É–¥ */
    #hotspots{position:fixed;inset:0;z-index:var(--z-hot);display:none;pointer-events:none}
    .hotbtn{
      position:absolute;transform:translate(-50%,-50%);
      pointer-events:auto;padding:12px 16px;border:0;border-radius:12px;
      background:#111;color:#fff;font-weight:700;font-size:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.28);opacity:0;animation:hotIn .25s ease forwards
    }
    @keyframes hotIn{from{opacity:0;transform:translate(-50%,-58%)}to{opacity:1;transform:translate(-50%,-50%)}}

    /* Autoplay —Å–∞–Ω—É—É–ª–≥–∞ */
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}

    /* –°–æ–Ω–≥–æ–ª—Ç–æ–æ—Ä reset */
    #reset{position:fixed;right:12px;bottom:20px;z-index:var(--z-menu);padding:10px 12px;border:0;border-radius:10px;background:#fff;color:#111;cursor:pointer;display:none}
  </style>
</head>
<body>
  <!-- –ö–∞–º–µ—Ä -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- –í–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- –¶–∞–≥—Ç–∞–π –≥–∞—Ä—á-–∞–ª–≥–∞ –±–æ–ª–¥–æ–≥ —Ç–æ–≤—á–Ω—É—É–¥ -->
  <div id="hotspots"></div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <button id="reset" type="button">Reset</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  /* ====== –¢–∞–Ω—ã URL-—É—É–¥ ====== */
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";

  /* ====== –≠–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥ ====== */
  const cam=document.getElementById('cam'), wrap=document.getElementById('overlay-wrap');
  const intro=document.getElementById('intro'), exercise=document.getElementById('exercise');
  const menu=document.getElementById('menu'), btnExercise=document.getElementById('btnExercise');
  const toast=document.getElementById('toast'), resetBtn=document.getElementById('reset');
  const hotspotLayer=document.getElementById('hotspots');

  /* ====== –ö–∞–º–µ—Ä ====== */
  async function startCamera(){
    try{
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
      cam.srcObject=s; await cam.play();
    }catch(e){ /* –∫–∞–º–µ—Ä–≥“Ø–π PC –¥—ç—ç—Ä –∞–ª–¥–∞–∞ –∞–≤–±–∞–ª –∑“Ø–≥—ç—ç—Ä –ª “Ø—Ä–≥—ç–ª–∂–ª“Ø“Ø–ª–Ω—ç */
      console.warn('No camera, AR background disabled:', e.message);
      cam.style.display='none';
    }
  }

  /* ====== –í–∏–¥–µ–æ —ç—Ö —Å—É—Ä–≤–∞–ª–∂ ====== */
  function setSources(el,url){ el.innerHTML=""; const s=document.createElement('source'); s.src=url; s.type='video/webm; codecs="vp8,opus"'; el.appendChild(s); }

  /* ====== Drag + Pinch-Zoom ====== */
  let active=null, scale=1, startScale=1, tx=0, ty=0, startX=0, startY=0, startDist=0;
  const dist=(a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
  function applyTransform(){ if(!active) return; active.style.transform=`translate(${tx}px, ${ty}px) scale(${scale})`; }
  function resetTransform(){ scale=1; tx=0; ty=0; applyTransform(); }
  function bindGesture(el){
    el.addEventListener('mousedown',e=>{ startX=e.clientX-tx; startY=e.clientY-ty;
      const mm=e2=>{ tx=e2.clientX-startX; ty=e2.clientY-startY; applyTransform(); };
      const mu=()=>{ window.removeEventListener('mousemove',mm); window.removeEventListener('mouseup',mu); };
      window.addEventListener('mousemove',mm); window.addEventListener('mouseup',mu);
    });
    el.addEventListener('touchstart',e=>{
      if(!active) return;
      if(e.touches.length===1){ startX=e.touches[0].clientX-tx; startY=e.touches[0].clientY-ty; }
      else if(e.touches.length===2){ startDist=dist(e.touches[0],e.touches[1]); startScale=scale; }
    },{passive:false});
    el.addEventListener('touchmove',e=>{
      if(!active) return; e.preventDefault();
      if(e.touches.length===1){ tx=e.touches[0].clientX-startX; ty=e.touches[0].clientY-startY; }
      else if(e.touches.length===2){ const d=dist(e.touches[0],e.touches[1]); scale=Math.max(0.5,Math.min(3,startScale*(d/startDist))); }
      applyTransform();
    },{passive:false});
  }
  wrap.addEventListener('click',(()=>{let t=0;return()=>{const n=Date.now(); if(n-t<300) resetTransform(); t=n; };})());
  resetBtn.addEventListener('click',resetTransform);

  /* ====== –ê—É–¥–∏–æ autoplay fallback ====== */
  async function playWithAudio(el){
    el.muted=false; el.volume=1.0;
    try{ await el.play(); toast.style.display='none'; }
    catch{ toast.style.display='block'; el.muted=true; el.play().catch(()=>{});
      const enable=()=>{ el.muted=false; el.volume=1.0; toast.style.display='none'; document.removeEventListener('pointerdown',enable,{passive:true}); };
      document.addEventListener('pointerdown',enable,{passive:true,once:true});
    }
  }

  /* ====== Hotspot —Å—Ü–µ–Ω–∞—Ä–∏–π–Ω –ñ–ò–®–≠–≠ ====== */
  // x,y ‚Äî % –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç; start/end ‚Äî —Å–µ–∫—É–Ω–¥
  const INTRO_HOTSPOTS = [
    {start:3, end:6, items:[
      {id:'hsGuide', label:'–ó–∞–∞–≤–∞—Ä',   x:30, y:55, action:()=>alert('–ó–∞–∞–≤–∞—Ä!')},
      {id:'hsInfo',  label:'–ú—ç–¥—ç—ç–ª—ç–ª', x:65, y:40, action:()=>alert('–ú—ç–¥—ç—ç–ª—ç–ª!')}
    ]},
    {start:8, end:11, items:[
      {id:'hsGoEx',  label:'–î–∞—Å–≥–∞–ª —Ä—É—É', x:50, y:80, action:startExercise}
    ]}
  ];
  const EXERCISE_HOTSPOTS = [
    {start:5, end:9, items:[
      {id:'hsBack', label:'–ë—É—Ü–∞—Ö', x:85, y:85, action:showMenu}
    ]}
  ];

  let hotspotSpec=[], lastWindow=null;
  function clearHotspots(){ hotspotLayer.innerHTML=""; hotspotLayer.style.display="none"; lastWindow=null; }
  function renderHotspots(items){
    hotspotLayer.innerHTML=""; hotspotLayer.style.display="block";
    for(const it of items){
      const b=document.createElement('button');
      b.className='hotbtn'; b.textContent=it.label;
      b.style.left=it.x+'%'; b.style.top=it.y+'%';
      b.onclick=(e)=>{ e.stopPropagation(); it.action && it.action(); };
      hotspotLayer.appendChild(b);
    }
  }
  function updateHotspots(t){
    const win = hotspotSpec.find(w=>t>=w.start && t<=w.end) || null;
    if(!win){ if(lastWindow) clearHotspots(); return; }
    if(lastWindow && win.start===lastWindow.start && win.end===lastWindow.end) return;
    lastWindow = win; renderHotspots(win.items);
  }
  function onTimeUpdate(){ updateHotspots(this.currentTime); }

  /* ====== –£—Ä—Å–≥–∞–ª ====== */
  async function boot(){
    await startCamera();

    setSources(intro,INTRO_URL); setSources(exercise,EXERCISE_URL);
    bindGesture(intro); bindGesture(exercise);

    wrap.style.display='block'; resetBtn.style.display='inline-block';

    // Intro
    active=intro; resetTransform();
    intro.currentTime=0; intro.style.display='block';
    hotspotSpec=INTRO_HOTSPOTS; intro.addEventListener('timeupdate',onTimeUpdate);
    await playWithAudio(intro);
  }

  intro.addEventListener('ended', ()=>{
    clearHotspots();
    intro.removeEventListener('timeupdate',onTimeUpdate);
    intro.style.display='none'; active=null; menu.style.display='flex';
  });

  async function startExercise(){
    menu.style.display='none';
    clearHotspots();
    exercise.currentTime=0; exercise.style.display='block';
    active=exercise; resetTransform();
    hotspotSpec=EXERCISE_HOTSPOTS; exercise.addEventListener('timeupdate',onTimeUpdate);
    await playWithAudio(exercise);
  }
  function showMenu(){
    clearHotspots();
    if(active){ active.pause(); active.style.display='none'; }
    active=null; menu.style.display='flex';
  }
  btnExercise.addEventListener('click', startExercise);

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
